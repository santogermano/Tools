<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>RSS Newsletter Generator v2.0</title>
<style>
:root{
  --bg: #f8fafc;
  --card: #ffffff;
  --muted: #64748b;
  --ink: #0f172a;
  --border: #e2e8f0;
  --accent: #3b82f6;
  --accent-600: #2563eb;
  --accent-700: #1d4ed8;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --radius: 14px;
  --radius-sm: 10px;
  --shadow-xs: 0 1px 2px rgba(15,23,42,0.04);
  --shadow-sm: 0 2px 8px rgba(15,23,42,0.06), 0 1px 2px rgba(15,23,42,0.04);
  --shadow-md: 0 4px 16px rgba(15,23,42,0.08), 0 2px 4px rgba(15,23,42,0.04);
  --shadow-lg: 0 12px 32px rgba(15,23,42,0.12), 0 4px 8px rgba(15,23,42,0.06);
  --modal-bg: rgba(15,23,42,0.7);
  --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-normal: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Enhanced light theme with refined aesthetics */

*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;letter-spacing:-0.01em;}
.container{display:grid;grid-template-columns:1fr 540px;gap:24px;max-width:1360px;margin:28px auto;padding:20px;animation:fadeIn 0.4s ease-out;}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@media (max-width:1200px){.container{grid-template-columns:1fr}}
body.dock-bottom .container{grid-template-columns:1fr}

.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);transition:box-shadow var(--transition-normal), transform var(--transition-normal);margin-bottom:4px;}
.card:hover{box-shadow:var(--shadow-md)}
.row{display:flex;gap:14px;flex-wrap:wrap;margin:14px 0}
.row--tight{gap:10px;margin:10px 0}
.row>div{flex:1 1 260px;min-width:220px}
h1{font-size:22px;margin:8px 0 6px;color:var(--ink);font-weight:800;letter-spacing:-0.02em}
h1 .hint{font-weight:500;color:var(--muted);font-size:13px;margin-left:10px}
h2{font-size:15px;margin:0 0 10px;color:var(--ink);font-weight:700;display:flex;align-items:center;gap:8px}
h2::before{content:'';display:inline-block;width:4px;height:16px;background:var(--accent);border-radius:2px}

label{display:block;font-weight:600;margin:0 0 8px;color:#1e293b;font-size:13px;letter-spacing:0.01em}
input[type="text"],input[type="number"],input[type="url"],select,textarea{
  width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:#fff;color:var(--ink);outline:none;transition:all var(--transition-fast);font-size:14px;
  box-shadow:var(--shadow-xs);
}
input[type="text"]:hover,input[type="number"]:hover,input[type="url"]:hover,select:hover,textarea:hover{border-color:#cbd5e1}
input[type="text"]:focus,input[type="number"]:focus,input[type="url"]:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15), var(--shadow-sm)}
textarea{min-height:120px;resize:vertical;line-height:1.6}
#headerSub{min-height:84px;}

/* Input with icon (RSS URL) */
.input-with-icon{position:relative}
.input-with-icon input{padding-right:40px}
.input-with-icon .icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);pointer-events:none;opacity:.7}

/* Drag feedback for section rows */
#sectionsList .section-row.drag-over{border-color:#93c5fd;background:#f0f9ff}

.hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.5}
.badge{display:inline-flex;align-items:center;background:linear-gradient(135deg,#eef2ff,#e0e7ff);color:#4338ca;border:1px solid #c7d2fe;border-radius:999px;padding:5px 12px;font-size:12px;font-weight:600;gap:4px;transition:all var(--transition-fast)}
.badge:hover{background:linear-gradient(135deg,#e0e7ff,#c7d2fe)}
.small{font-size:13px;color:var(--muted)}
.small-muted{font-size:12px;color:var(--muted)}

.btn{border:1.5px solid var(--border);background:#fff;border-radius:var(--radius-sm);padding:9px 16px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;color:var(--ink);font-weight:600;font-size:13px;transition:all var(--transition-fast);position:relative;overflow:hidden}
.btn::before{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.8),rgba(255,255,255,0));pointer-events:none}
.btn:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:#cbd5e1}
.btn:active{transform:translateY(0);box-shadow:var(--shadow-sm)}
.btn:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(59,130,246,0.3)}
.btn-primary{border-color:var(--accent-700);background:linear-gradient(180deg,var(--accent),var(--accent-600));color:#fff;box-shadow:0 4px 14px rgba(59,130,246,0.25);text-shadow:0 1px 1px rgba(0,0,0,0.1)}
.btn-primary:hover{background:linear-gradient(180deg,var(--accent-600),var(--accent-700));box-shadow:0 6px 20px rgba(59,130,246,0.35)}
.btn-ghost{background:transparent;border-color:transparent;color:var(--accent);font-weight:600}
.btn-ghost:hover{background:rgba(59,130,246,0.08);border-color:rgba(59,130,246,0.2)}
.btn-group{display:inline-flex;border-radius:var(--radius-sm);overflow:hidden;border:1.5px solid var(--border);background:#fff;box-shadow:var(--shadow-xs)}
.btn-group .btn{border:0;border-right:1px solid var(--border);padding:9px 14px;border-radius:0}
.btn-group .btn::before{display:none}
.btn-group .btn:last-child{border-right:0}
.btn-group .btn:hover{background:#f1f5f9}
.btn.active,.btn-group .btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-600));color:#fff;border-color:var(--accent-600)}

.article-item{display:grid;grid-template-columns:32px 32px 1fr 48px;gap:14px;align-items:center;border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;background:#fff;margin:10px 0;transition:all var(--transition-fast);position:relative}
.article-item::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px;background:var(--accent);border-radius:var(--radius) 0 0 var(--radius);opacity:0;transition:opacity var(--transition-fast)}
.article-item:hover{transform:translateY(-3px);box-shadow:var(--shadow-md);border-color:#cbd5e1}
.article-item:hover::before{opacity:1}
.article-item .drag{cursor:grab;color:#94a3b8;font-size:18px;display:flex;align-items:center;justify-content:center;transition:color var(--transition-fast)}
.article-item .drag:hover{color:var(--accent)}
.article-item .title{font-weight:600;color:var(--ink);font-size:14px;line-height:1.4}
.article-item .hint{font-size:12px;color:var(--muted);margin-top:4px}
.article-item .star{cursor:pointer;color:#fbbf24;font-size:20px;display:inline-flex;align-items:center;justify-content:center;transition:all var(--transition-fast);filter:drop-shadow(0 1px 2px rgba(251,191,36,0.3))}
.article-item .star:hover{transform:scale(1.2);filter:drop-shadow(0 2px 4px rgba(251,191,36,0.4))}
.article-item.drag-over{border-color:var(--accent);background:rgba(59,130,246,0.05);box-shadow:0 0 0 3px rgba(59,130,246,0.1)}

/* Sections board */
#sectionsList .section-row{display:grid;grid-template-columns:32px 1fr 160px 160px 120px;gap:14px;align-items:center;border:1.5px solid var(--border);border-radius:var(--radius);padding:14px 16px;background:#fff;margin:10px 0;transition:all var(--transition-fast)}
#sectionsList .section-row:hover{box-shadow:var(--shadow-sm);border-color:#cbd5e1}
#sectionsList .drag{cursor:grab;color:#94a3b8;font-size:18px;display:flex;align-items:center;justify-content:center;transition:color var(--transition-fast)}
#sectionsList .drag:hover{color:var(--accent)}
.swatch{width:20px;height:20px;border-radius:8px;border:2px solid rgba(0,0,0,0.08);display:inline-block;vertical-align:middle;margin-right:10px;box-shadow:var(--shadow-xs)}
.toc-badge-mini{display:inline-flex;align-items:center;border:1.5px solid #c7d2fe;border-radius:9999px;padding:6px 12px;font-size:12px;line-height:1.2;background:linear-gradient(135deg,#eef2ff,#e0e7ff);color:#1e293b;white-space:nowrap;font-weight:600;transition:all var(--transition-fast)}
.toc-badge-mini:hover{box-shadow:var(--shadow-sm)}

/* Preview */
#rightCol{position:relative}
.preview-card{position:sticky;top:20px;border-radius:var(--radius);box-shadow:var(--shadow-lg);background:#fff;overflow:hidden}
body.dock-bottom .preview-card{position:static}
.preview-head{display:flex;align-items:center;gap:14px;justify-content:space-between;margin-bottom:12px;padding:8px 4px;flex-wrap:wrap}
.preview-head strong{font-size:14px;font-weight:700;color:var(--ink);display:flex;align-items:center;gap:8px}
.preview-head strong::before{content:'';display:inline-block;width:8px;height:8px;background:var(--success);border-radius:50%;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
#previewWrap{border-radius:var(--radius-sm);border:1.5px solid var(--border);overflow:hidden;background:#fff;box-shadow:var(--shadow-xs) inset}
#previewFrame{width:100%;height:720px;border:0;display:block;background:#fff}

/* Inline visual editor (edits directly in live preview) */
.inline-editor{display:none;margin:10px 0 10px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff}
.inline-editor[aria-hidden="false"]{display:block}
.inline-editor .ie-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px 10px;border-bottom:1px solid #eef2f7;background:#ffffff}
.inline-editor .ie-group{display:flex;gap:6px;align-items:center;padding-right:8px;border-right:1px solid #eef2f7}
.inline-editor .ie-group:last-child{border-right:0;padding-right:0}
.inline-editor .ie-btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:700;font-size:13px;line-height:1}
.inline-editor .ie-btn:hover{box-shadow:var(--shadow-sm);transform:translateY(-1px)}
.inline-editor .ie-btn:active{transform:translateY(0)}
.inline-editor .ie-select{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;font-weight:700}
.inline-editor .ie-foot{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px;background:#fbfdff;border-top:1px solid #eef2f7}
.inline-editor .ie-meta{font-size:12px;color:var(--muted)}
.inline-editor .ie-scope{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.inline-editor .ie-source{display:none;border-top:1px solid #eef2f7;background:#ffffff}
.inline-editor .ie-source[aria-hidden="false"]{display:block}
.inline-editor .ie-source textarea{width:100%;min-height:220px;border:0;outline:none;padding:12px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;line-height:1.45;resize:vertical}
.inline-editor .ie-source-actions{display:flex;justify-content:flex-end;gap:8px;padding:10px 12px;border-top:1px solid #eef2f7;background:#fbfdff}


/* Mode visibility */
.advanced-only{display:block}
body.simple .advanced-only{display:none !important}

html.modal-open, body.modal-open{overflow:hidden}

/* Visual editor modal */
#visualModal{display:none;position:fixed;inset:0;z-index:9999;background:var(--modal-bg);align-items:flex-start;justify-content:center;padding:22px;overflow:auto}
#visualModal[aria-hidden="false"]{display:flex}
#visualModal .ve-card{width:100%;max-width:1180px;background:#fff;border-radius:16px;box-shadow:0 24px 70px rgba(2,6,23,0.65);overflow:hidden;border:1px solid rgba(255,255,255,0.12);max-height:calc(100vh - 44px);display:flex;flex-direction:column;margin:0 auto}
#visualModal .ve-topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid #eef2f7;background:linear-gradient(180deg,#ffffff,#fbfdff)}
#visualModal .ve-title{font-weight:800;color:#0f172a;font-size:14px;letter-spacing:0.2px}
#visualModal .ve-actions{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
#visualModal .ve-actions select{padding:7px 10px;border-radius:10px;border:1px solid var(--border);background:#fff;font-weight:600}
#visualModal .ve-iconbtn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:7px 10px;cursor:pointer;font-weight:800}
#visualModal .ve-iconbtn:hover{box-shadow:var(--shadow-sm);transform:translateY(-1px)}
#visualModal .ve-body{padding:12px;flex:1 1 auto;min-height:0;overflow:auto}
#visualModal .ve-split{display:grid;grid-template-columns:1fr 420px;gap:12px;align-items:stretch;min-height:0}
#visualModal .ve-pane{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;display:flex;flex-direction:column;min-height:0}
#visualModal .ve-pane-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid #eef2f7;background:#fbfdff}
#visualModal .ve-pane-head .small-muted{margin:0}
#visualModal .ve-pane-body{padding:0;flex:1 1 auto;min-height:0}

#visualModal .ve-editor-shell{display:flex;flex-direction:column;min-height:0}
#visualModal .ve-toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:10px 10px;border-bottom:1px solid #eef2f7;background:#ffffff}
#visualModal .ve-toolbar-group{display:flex;gap:6px;align-items:center;padding-right:8px;border-right:1px solid #eef2f7}
#visualModal .ve-toolbar-group:last-child{border-right:0;padding-right:0}
#visualModal .ve-tbtn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-weight:700;font-size:13px;line-height:1}
#visualModal .ve-tbtn:hover{box-shadow:var(--shadow-sm);transform:translateY(-1px)}
#visualModal .ve-tbtn:active{transform:translateY(0)}
#visualModal .ve-tselect{border:1px solid var(--border);background:#fff;border-radius:10px;padding:6px 10px;font-weight:700}
#visualModal .ve-editor-wrap{flex:1 1 auto;min-height:0;display:flex;flex-direction:column}
#visualModal .ve-rich-editor{flex:1 1 auto;min-height:0;overflow:auto;padding:14px;outline:none}
#visualModal .ve-rich-editor:focus{box-shadow:0 0 0 3px rgba(37,99,235,0.12) inset}
#visualModal .ve-source-editor{flex:1 1 auto;min-height:0;overflow:auto;padding:14px;border:0;outline:none;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;line-height:1.45}

#visualModal .ve-rich-editor{font-family:Aptos,'Aptos Display','Segoe UI',Calibri,Arial,sans-serif;font-size:14px;line-height:1.5;color:#111827;background:#ffffff}
#visualModal .ve-rich-editor p{margin:0 0 10px}
#visualModal .ve-rich-editor h2{margin:0 0 10px;font-size:18px;line-height:1.25}
#visualModal .ve-rich-editor h3{margin:0 0 10px;font-size:16px;line-height:1.25}
#visualModal .ve-rich-editor a{color:#2563eb;text-decoration:none}
#visualModal .ve-rich-editor img{max-width:100%;height:auto}
#visualModal .ve-rich-editor table{border-collapse:collapse;width:100%}
#visualModal .ve-rich-editor td,#visualModal .ve-rich-editor th{border:1px solid #e5e7eb;padding:8px;vertical-align:top}

#visualModal .ve-preview-frame{width:100%;height:clamp(360px, calc(100vh - 340px), 650px);border:0;display:block;background:#fff}
#visualModal .ve-fallback{display:none;padding:14px}
#visualModal .ve-fallback .hint{margin:0}
#visualModal .ve-fallback-editor{min-height:clamp(340px, calc(100vh - 360px), 560px);border:1px solid var(--border);border-radius:10px;padding:14px;outline:none;overflow:auto}
#visualModal .ve-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-top:1px solid #eef2f7;background:#ffffff}
#visualModal .ve-status{font-size:12px;color:var(--muted)}
@media (max-width: 980px){
  #visualModal{padding:14px}
  #visualModal .ve-split{grid-template-columns:1fr}
  #visualModal .ve-preview-frame{height:clamp(320px, calc(100vh - 340px), 520px)}
}


/* ==================== ENHANCED VISUAL EDITOR ==================== */
#visualEditorPanel{display:none;position:fixed;inset:0;z-index:9998;background:var(--bg);overflow:hidden;animation:veSlideIn 0.3s ease-out}
#visualEditorPanel.active{display:flex;flex-direction:column}
@keyframes veSlideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}

.ve-header{display:flex;align-items:center;justify-content:space-between;gap:16px;padding:16px 24px;background:#fff;border-bottom:1px solid var(--border);box-shadow:var(--shadow-sm);flex-shrink:0}
.ve-header-title{font-size:16px;font-weight:800;color:var(--ink);display:flex;align-items:center;gap:10px}
.ve-header-title svg{color:var(--accent)}
.ve-header-actions{display:flex;align-items:center;gap:10px}

.ve-main{flex:1;display:grid;grid-template-columns:380px 1fr;gap:0;overflow:hidden}
@media(max-width:900px){.ve-main{grid-template-columns:1fr}}

.ve-sidebar{background:#fff;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.ve-sidebar-header{padding:16px 20px;border-bottom:1px solid var(--border);background:#f8fafc}
.ve-sidebar-header h3{margin:0 0 4px;font-size:14px;font-weight:700;color:var(--ink)}
.ve-sidebar-header p{margin:0;font-size:12px;color:var(--muted)}
.ve-sidebar-content{flex:1;overflow-y:auto;padding:16px}

/* Section cards in visual editor */
.ve-section{background:#fff;border:2px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;transition:all var(--transition-fast)}
.ve-section.dragging{opacity:0.5;border-style:dashed}
.ve-section.drag-over{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,0.15)}
.ve-section-header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:linear-gradient(180deg,#f8fafc,#fff);border-bottom:1px solid var(--border);cursor:grab}
.ve-section-header:active{cursor:grabbing}
.ve-section-drag{color:#94a3b8;font-size:18px;flex-shrink:0}
.ve-section-color{width:16px;height:16px;border-radius:6px;flex-shrink:0;border:2px solid rgba(0,0,0,0.1)}
.ve-section-name{flex:1;font-weight:700;font-size:14px;color:var(--ink)}
.ve-section-count{font-size:12px;color:var(--muted);background:#f1f5f9;padding:2px 8px;border-radius:99px}
.ve-section-toggle{background:none;border:none;cursor:pointer;padding:4px;color:var(--muted);transition:transform var(--transition-fast)}
.ve-section-toggle.collapsed{transform:rotate(-90deg)}
.ve-section-articles{padding:8px}
.ve-section-articles.collapsed{display:none}

/* Article items in visual editor */
.ve-article{display:flex;align-items:flex-start;gap:12px;padding:12px;background:#fff;border:1.5px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:grab;transition:all var(--transition-fast)}
.ve-article:hover{border-color:#cbd5e1;box-shadow:var(--shadow-sm)}
.ve-article:active{cursor:grabbing}
.ve-article.dragging{opacity:0.4;border-style:dashed;background:#f8fafc}
.ve-article.drag-over{border-color:var(--accent);background:rgba(59,130,246,0.05)}
.ve-article-drag{color:#cbd5e1;font-size:16px;flex-shrink:0;margin-top:2px}
.ve-article-content{flex:1;min-width:0}
.ve-article-title{font-weight:600;font-size:13px;color:var(--ink);margin-bottom:4px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.ve-article-meta{font-size:11px;color:var(--muted);display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.ve-article-actions{display:flex;flex-direction:column;gap:6px;flex-shrink:0}
.ve-article-action{width:28px;height:28px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all var(--transition-fast)}
.ve-article-action:hover{background:#f1f5f9;border-color:#cbd5e1}
.ve-article-action.active{background:#fef3c7;border-color:#fbbf24;color:#d97706}
.ve-article-action.exclude{opacity:0.5}

/* Quick edit modal */
.ve-quick-edit{position:fixed;inset:0;z-index:10000;background:rgba(15,23,42,0.6);display:none;align-items:center;justify-content:center;padding:20px;animation:fadeIn 0.2s ease-out}
.ve-quick-edit.active{display:flex}
.ve-quick-edit-card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow-lg);width:100%;max-width:600px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column}
.ve-quick-edit-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border);background:#f8fafc}
.ve-quick-edit-header h3{margin:0;font-size:15px;font-weight:700}
.ve-quick-edit-close{background:none;border:none;cursor:pointer;padding:4px;color:var(--muted);font-size:20px}
.ve-quick-edit-body{padding:20px;overflow-y:auto;flex:1}
.ve-quick-edit-field{margin-bottom:16px}
.ve-quick-edit-field label{display:block;font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}
.ve-quick-edit-field input,.ve-quick-edit-field textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:14px}
.ve-quick-edit-field textarea{min-height:120px;resize:vertical;line-height:1.6}
.ve-quick-edit-footer{display:flex;justify-content:flex-end;gap:10px;padding:16px 20px;border-top:1px solid var(--border);background:#f8fafc}

/* Preview pane */
.ve-preview{background:#f8fafc;display:flex;flex-direction:column;overflow:hidden}
.ve-preview-header{padding:12px 20px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.ve-preview-header h3{margin:0;font-size:14px;font-weight:700;color:var(--ink)}
.ve-preview-content{flex:1;padding:20px;overflow:auto}
.ve-preview-frame-wrap{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow-md);overflow:hidden}
.ve-preview-frame{width:100%;height:100%;min-height:500px;border:0;display:block}

/* Empty state */
.ve-empty{text-align:center;padding:40px 20px;color:var(--muted)}
.ve-empty svg{width:48px;height:48px;margin-bottom:12px;opacity:0.4}
.ve-empty p{margin:0;font-size:14px}

/* Misc tweaks */
.kv{font-size:13px;color:var(--muted)}
.footer-note{font-size:13px;color:var(--muted);margin-top:8px}
.controls-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.center{display:flex;align-items:center;justify-content:center}

/* Toast notifications */
.toast-container{position:fixed;bottom:24px;right:24px;z-index:99999;display:flex;flex-direction:column;gap:10px;pointer-events:none}
.toast{background:linear-gradient(135deg,#1e293b,#0f172a);color:#fff;padding:14px 20px;border-radius:var(--radius);box-shadow:var(--shadow-lg);font-size:14px;font-weight:500;display:flex;align-items:center;gap:10px;animation:toastIn 0.3s ease-out;pointer-events:auto;max-width:360px}
.toast.toast-success{background:linear-gradient(135deg,#059669,#047857)}
.toast.toast-error{background:linear-gradient(135deg,#dc2626,#b91c1c)}
.toast.toast-warning{background:linear-gradient(135deg,#d97706,#b45309)}
@keyframes toastIn{from{opacity:0;transform:translateY(20px) scale(0.95)}to{opacity:1;transform:translateY(0) scale(1)}}
@keyframes toastOut{from{opacity:1;transform:translateY(0) scale(1)}to{opacity:0;transform:translateY(-10px) scale(0.95)}}
.toast.hiding{animation:toastOut 0.2s ease-in forwards}

/* Loading spinner */
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Checkbox styling */
input[type="checkbox"]{width:18px;height:18px;accent-color:var(--accent);cursor:pointer;border-radius:4px}

/* Responsiveness */
@media (max-width:880px){
  .container{grid-template-columns:1fr;padding:16px}
  #previewFrame{height:520px}
  #visualModal .editor-area{flex-direction:column}
  #visualModal .html-view{width:100%;min-width:auto;max-width:none;border-left:0;border-top:1px solid #f3f4f6}
  .preview-head{flex-direction:column;align-items:flex-start}
  .article-item{grid-template-columns:28px 28px 1fr 40px;padding:12px}
  #sectionsList .section-row{grid-template-columns:28px 1fr;gap:10px}
  #sectionsList .section-row>div:nth-child(3),#sectionsList .section-row>div:nth-child(4),#sectionsList .section-row>div:nth-child(5){display:none}
}
</style>
</head>
<body class="simple">
<div class="container">
  <div id="leftCol">
    <h1>RSS Newsletter Generator <span class="badge" style="font-size:11px;padding:3px 8px;margin-left:6px;vertical-align:middle">v2.0</span></h1>

    <!-- Mode -->
    <div class="card" id="modeCard">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <strong>Mode</strong>
          <div role="group" aria-label="UI mode" class="btn-group">
            <button type="button" id="modeSimple" class="btn active">Simple</button>
            <button type="button" id="modeAdvanced" class="btn">Advanced</button>
          </div>
        </div>
        <span class="small-muted">Simple shows essentials; Advanced reveals all controls.</span>
      </div>
    </div>

    <!-- 1) Feed & Filters -->
    <div class="card" id="feedCard">
      <h2>1) Feed &amp; Filters</h2>
      <div class="row">
        <div>
          <label for="rssUrl">RSS / Atom URL</label>
          <div class="input-with-icon">
            <!-- Use type=url to hint the browser to validate and format the address. -->
            <input type="url" id="rssUrl" placeholder="https://example.com/feed.xml" autocomplete="off">
            <!-- Provide accessibility metadata for the decorative icon. -->
            <span class="icon" role="img" aria-label="RSS feed link icon">üîó</span>
          </div>
          <div class="hint">RSS (&lt;item&gt;) and Atom (&lt;entry&gt;) supported.</div>
        </div>
        <div>
          <label>&nbsp;</label>
          <div class="row controls-row">
            <button class="btn btn-primary" id="generateBtn">Generate</button>
            <button class="btn" id="refreshBtn">Refresh</button>
            <span id="status" class="badge">Idle</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="feedSource">Feed source</label>
          <select id="feedSource">
            <option value="url" selected>Load from URL (with CORS fallbacks)</option>
            <option value="paste">Paste RSS/Atom XML (no network)</option>
          </select>
          <div class="hint">If your browser blocks RSS downloads (CORS), switch to Paste XML.</div>
        </div>
      </div>
      <div class="row" id="feedPasteRow" style="display:none">
        <div>
          <label for="feedXml">RSS/Atom XML</label>
          <textarea id="feedXml" spellcheck="false" placeholder="Paste the full RSS/Atom XML here‚Ä¶"></textarea>
          <div class="hint">No network request is made in this mode.</div>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="mappingMode">Text mapping</label>
          <select id="mappingMode">
            <option value="auto" selected>Auto (prefer Content)</option>
            <option value="descPreview_contentNote">Preview = Description, Comment = Content</option>
            <option value="contentPreview_descNote">Preview = Content, Comment = Description</option>
            <option value="descOnly">Description only</option>
            <option value="contentOnly">Content only</option>
          </select>
          <div class="hint">Controls which fields feed the Preview and Comment.</div>
        </div>
        <div class="advanced-only">
          <label>Filter</label>
          <div class="row row--tight">
            <div><label for="daysBack">Last N days</label><input type="number" id="daysBack" min="0" value="0"></div>
            <div><label for="limitItems">Max items</label><input type="number" id="limitItems" min="0" value="0"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2) Curate -->
    <div class="card" id="curateCard">
      <h2>2) Curate (select & edit)</h2>
      <div class="row"><span class="hint">Open Advanced to reorder within a section (drag by ‚â°) and mark ‚≠ê featured.</span></div>
      <div id="articleList" class="advanced-only"></div>
    </div>

    <!-- 3) Sections (order, colors, emoji) -->
    <div class="card" id="sectionsCard">
      <h2>3) Sections (order, colors, emoji)</h2>
      <div class="row"><div class="hint">Drag rows to reorder sections. Choose a color from the dropdown‚Äîswatch and ToC badge preview update instantly.</div></div>
      <div id="sectionsList"></div>
    </div>

    <!-- 4) Header & Identity -->
    <div class="card" id="headerCard">
      <h2>4) Header &amp; Identity</h2>
      <div class="row">
        <div><label for="headerText">Title</label><input id="headerText" type="text" placeholder="Newsletter / Source"></div>
        <div><label for="headerSub">Intro message</label><textarea id="headerSub" placeholder="Add a short introduction (optional)."></textarea><div class="hint">Appears below the title.</div></div>
      </div>
      <div class="row">
        <div>
          <label for="headerColor">Header color</label>
          <select id="headerColor">
            <option value="#ffffff">White (neutral)</option>
            <option value="#111827">Slate</option>
            <option value="#2563eb">Blue</option>
            <option value="#7c3aed">Purple</option>
            <option value="#dc2626">Red</option>
            <option value="#10b981">Green</option>
            <option value="#f59e0b">Amber</option>
          </select>
          <div class="hint">Simple solid color for header background.</div>
        </div>
<div>
          <label for="issueNumber">Release #</label>
          <input type="text" id="issueNumber" placeholder="e.g., 12">
          <div class="hint">Shown in the header meta (top-right).</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Table of contents</label>
          <div class="row controls-row">
            <label><input type="checkbox" id="includeToc" checked> Include ToC</label>
            <label>Style
              <select id="tocPreset">
                <option value="minimal">Minimal</option>
                <option value="numbered">Numbered</option>
                <option value="badges">Badges</option>
                <option value="two-col">Two-column</option>
              </select>
            </label>
            <label>Links
              <select id="tocStyle">
                <option value="linked">Linked</option>
                <option value="plain">Plain</option>
              </select>
            </label>
          </div>
          <div class="hint">Badges adopt each section color (with Outlook-safe fallback).</div>
        </div>
      </div>
    </div>

    <!-- 5) Layout, Content & Images -->
    <div class="card" id="layoutCard">
      <h2>5) Layout, Content &amp; Images</h2>
      <div class="row">
        <div><label>Container width (% of 920px)</label><input type="number" id="containerPct" value="100" min="60" max="120"><div class="hint">Outlook-friendly base container = 920px.</div></div>
        <div>
          <label>Columns (non-featured)</label>
          <div class="btn-group" role="group" aria-label="Columns" id="columnsGroup">
            <button class="btn active" data-cols="1" type="button">1</button>
            <button class="btn" data-cols="2" type="button">2</button>
            <button class="btn" data-cols="3" type="button">3</button>
          </div>
          <div class="hint">Non-featured items per row.</div>
        </div>
      </div>
      <div class="row">
        <div><label>Base font size (px)</label><input type="number" id="baseFontPx" value="15" min="12" max="18"></div>
        <div><label>Line height</label><input type="number" id="lineHeight" value="1.5" step="0.1" min="1.1" max="1.8"></div>
        <div><label>Link style</label><select id="linkStyle"><option value="blue" selected>Blue</option><option value="gray">Gray</option><option value="accent">Accent</option></select></div>
        <div><label>Template theme</label>
          <select id="templateTheme">
            <option value="cards">Cards (bordered)</option>
            <option value="clean">Clean (no boxes)</option>
            <option value="divider">Spaced (no lines)</option>
            <option value="stripe">Accent stripe</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Font family</label>
          <select id="fontFamily">
            <option value="aptos">Aptos (Outlook)</option>
            <option value="segoe">Segoe UI</option>
            <option value="calibri">Calibri</option>
            <option value="arial">Arial</option>
            <option value="verdana">Verdana</option>
            <option value="georgia">Georgia</option>
            <option value="times">Times New Roman</option>
            <option value="custom">Custom</option>
          </select>
          <div class="hint">Applied to the exported template and preview.</div>
        </div>
        <div><label>Article title size (px)</label><input type="number" id="articleTitlePx" value="12" min="10" max="18"></div>
        <div><label>Article text size (px)</label><input type="number" id="articleBodyPx" value="10" min="9" max="16"></div>
        <div class="advanced-only"><label>Link size (px)</label><input type="number" id="linkFontPx" value="10" min="9" max="16"></div>
      </div>
      <div class="row" id="customFontRow" style="display:none">
        <div>
          <label>Custom font stack</label>
          <input type="text" id="customFontFamily" placeholder="e.g., 'IBM Plex Sans', 'Segoe UI', Calibri, Arial, sans-serif">
          <div class="hint">Used only when Font family is set to Custom.</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Article presentation</label>
          <select id="articlePresentation">
            <option value="standard">Standard</option>
            <option value="editorial" selected>Editorial (more readable)</option>
            <option value="compact">Compact</option>
          </select>
          <div class="hint">Controls how title + description/comment are displayed.</div>
        </div>
        <div>
          <label>Summary length (words)</label>
          <input type="number" id="summaryWords" value="0" min="0" max="160">
          <div class="hint">0 keeps full description.</div>
        </div>
        <div class="advanced-only">
          <label>Comment display</label>
          <select id="commentDisplay">
            <option value="auto" selected>Auto</option>
            <option value="hide">Hide</option>
            <option value="show">Show</option>
          </select>
        </div>
        <div class="advanced-only">
          <label>Comment style</label>
          <select id="commentStyle">
            <option value="callout" selected>Callout</option>
            <option value="takeaways">Key points (bullets)</option>
            <option value="sidenote">Side note (inline)</option>
            <option value="quote">Quote (pull-quote)</option>
            <option value="italic">Italic</option>
            <option value="plain">Plain</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div><label>Featured image width (px)</label><input type="number" id="featuredImageWidthPx" value="260" min="140" max="420"></div>
        <div><label>Image shape (featured)</label><select id="imageShape"><option value="rect" selected>Rectangle</option><option value="rounded">Rounded</option><option value="circle">Circle</option></select></div>
        <div><label>Corner radius (px)</label><input type="number" id="imageRadiusPx" value="10" min="0" max="48"></div>
      </div>
    </div>

    <!-- 6) Export -->
    <div class="card" id="exportCard">
      <h2>6) Export</h2>
      <div class="row">
        <div>
          <button class="btn" id="copyBtn" type="button">Copy HTML</button>
          <button class="btn" id="downloadBtn" type="button">Download HTML</button>
          <label class="row" style="align-items:center;gap:6px"><input type="checkbox" id="minifyToggle"> Minify</label>
          <label class="row" style="align-items:center;gap:6px"><input type="checkbox" id="outlookSafeToggle"> Outlook-only Safe Mode</label>
          <div id="lintBox" class="hint"></div>
          <div class="advanced-only" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;">
            <button class="btn" id="exportSettingsBtn" type="button">Export settings</button>
            <label for="importSettingsFile" class="btn" style="cursor:pointer">Import settings</label>
            <input id="importSettingsFile" type="file" accept="application/json" style="display:none">
            <button class="btn" id="resetToolBtn" type="button">Reset tool</button>
          </div>
          <div class="hint advanced-only">Export/Import saves tool settings (layout, fonts, sections). It does not include the current feed items.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Right column -->
  <div id="rightCol">
    <div class="card preview-card">
      <div class="preview-head">
        <strong>Live Preview</strong>
        <div class="row" style="align-items:center;gap:8px;margin:0">
          <button class="btn btn-primary" id="openVisualEditorBtn" type="button" style="padding:8px 14px">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
            Visual Editor
          </button>
          <label>Dock
            <select id="dockSelect">
              <option value="right" selected>Right</option>
              <option value="bottom">Bottom</option>
            </select>
          </label>
          <input type="range" id="zoomRange" min="0.75" max="1.5" step="0.05" value="1" style="width:110px">
          <div class="btn-group" aria-label="Zoom presets">
            <button class="btn" data-zoom="0.75" type="button">75%</button>
            <button class="btn" data-zoom="1.00" type="button">100%</button>
            <button class="btn" data-zoom="1.25" type="button">125%</button>
            <button class="btn" data-zoom="1.50" type="button">150%</button>
          </div>
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="outlookPreviewToggle"> Outlook preview</label>
          <button class="btn" id="visualEditBtn" type="button">Visual edit</button>
          <button class="btn btn-ghost" id="applyVisualBtn" type="button">Apply visual changes</button>
        </div>
      </div>
      
      <div class="inline-editor" id="inlineEditor" aria-hidden="true">
        <div class="ie-toolbar" role="toolbar" aria-label="Inline editor toolbar">
          <div class="ie-group">
            <button type="button" class="ie-btn" data-cmd="undo" title="Undo">‚Ü∂</button>
            <button type="button" class="ie-btn" data-cmd="redo" title="Redo">‚Ü∑</button>
          </div>
          <div class="ie-group">
            <select id="ieBlockSelect" class="ie-select" aria-label="Block style" title="Block style">
              <option value="P">Paragraph</option>
              <option value="H2">Heading 2</option>
              <option value="H3">Heading 3</option>
              <option value="BLOCKQUOTE">Quote</option>
            </select>
          </div>
          <div class="ie-group">
            <button type="button" class="ie-btn" data-cmd="bold" title="Bold"><b>B</b></button>
            <button type="button" class="ie-btn" data-cmd="italic" title="Italic"><i>I</i></button>
            <button type="button" class="ie-btn" data-cmd="underline" title="Underline"><u>U</u></button>
            <button type="button" class="ie-btn" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
          </div>
          <div class="ie-group">
            <button type="button" class="ie-btn" data-cmd="justifyLeft" title="Align left">‚ü∏</button>
            <button type="button" class="ie-btn" data-cmd="justifyCenter" title="Align center">‚â°</button>
            <button type="button" class="ie-btn" data-cmd="justifyRight" title="Align right">‚üπ</button>
            <button type="button" class="ie-btn" data-cmd="justifyFull" title="Justify">‚ò∞</button>
          </div>
          <div class="ie-group">
            <button type="button" class="ie-btn" data-cmd="insertUnorderedList" title="Bulleted list">‚Ä¢ List</button>
            <button type="button" class="ie-btn" data-cmd="insertOrderedList" title="Numbered list">1. List</button>
            <button type="button" class="ie-btn" data-cmd="outdent" title="Outdent">‚á§</button>
            <button type="button" class="ie-btn" data-cmd="indent" title="Indent">‚á•</button>
          </div>
          <div class="ie-group">
            <button type="button" class="ie-btn" data-action="link" title="Insert/edit link">Link</button>
            <button type="button" class="ie-btn" data-action="image" title="Insert image by URL">Image</button>
            <button type="button" class="ie-btn" data-action="table" title="Insert table">Table</button>
          </div>
          <div class="ie-group">
            <button type="button" class="ie-btn" data-action="removeformat" title="Remove formatting">Clear</button>
          </div>
        </div>

        <div class="ie-foot">
          <div class="ie-scope">
            <span class="ie-meta"><strong>Edit in preview</strong></span>
            <label class="small" style="display:flex;align-items:center;gap:8px;margin:0">
              Scope
              <select id="ieScope" class="ie-select" aria-label="Edit scope">
                <option value="content" selected>Content</option>
                <option value="full">Full HTML</option>
              </select>
            </label>
            <span id="ieState" class="ie-meta">Click inside the preview to edit. Use ‚ÄúApply visual changes‚Äù to save.</span>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="ieToggleHtmlBtn" type="button">HTML</button>
            <button class="btn" id="ieDiscardBtn" type="button">Discard</button>
          </div>
        </div>

        <div class="ie-source" id="ieSourceWrap" aria-hidden="true">
          <textarea id="ieSourceTextarea" spellcheck="false" aria-label="HTML source editor"></textarea>
          <div class="ie-source-actions">
            <button class="btn" id="ieApplyHtmlBtn" type="button">Update preview</button>
          </div>
        </div>
      </div>
<div id="previewWrap"><iframe id="previewFrame" title="preview"></iframe></div>
    </div>
  </div>
</div>

<!-- Visual editor modal (WYSIWYG) -->
<div id="visualModal" aria-hidden="true">
  <div class="ve-card" role="dialog" aria-modal="true" aria-labelledby="visualEditorTitle">
    <div class="ve-topbar">
      <div class="ve-title" id="visualEditorTitle">Visual editor</div>
      <div class="ve-actions">
        <label class="small-muted" style="margin:0">Edit scope</label>
        <select id="veScope" aria-label="Edit scope">
          <option value="content" selected>Content (recommended)</option>
          <option value="full">Full HTML (advanced)</option>
        </select>
        <button class="ve-iconbtn" type="button" id="veCloseBtn" title="Close">‚úï</button>
      </div>
    </div>

    <div class="ve-body">
      <div class="ve-split">
        <div class="ve-pane">
          <div class="ve-pane-head">
            <div class="small-muted">Editor</div>
            <div class="small-muted" id="veEditorState">Loading‚Ä¶</div>
          </div>
          <div class="ve-pane-body ve-editor-shell">
            <div class="ve-toolbar" role="toolbar" aria-label="Editor toolbar">
              <div class="ve-toolbar-group">
                <button type="button" class="ve-tbtn" data-cmd="undo" title="Undo">‚Ü∂</button>
                <button type="button" class="ve-tbtn" data-cmd="redo" title="Redo">‚Ü∑</button>
              </div>
              <div class="ve-toolbar-group">
                <select id="veBlockSelect" class="ve-tselect" aria-label="Block style" title="Block style">
                  <option value="P">Paragraph</option>
                  <option value="H2">Heading 2</option>
                  <option value="H3">Heading 3</option>
                  <option value="BLOCKQUOTE">Quote</option>
                </select>
              </div>
              <div class="ve-toolbar-group">
                <button type="button" class="ve-tbtn" data-cmd="bold" title="Bold"><b>B</b></button>
                <button type="button" class="ve-tbtn" data-cmd="italic" title="Italic"><i>I</i></button>
                <button type="button" class="ve-tbtn" data-cmd="underline" title="Underline"><u>U</u></button>
                <button type="button" class="ve-tbtn" data-cmd="strikeThrough" title="Strikethrough"><s>S</s></button>
              </div>
              <div class="ve-toolbar-group">
                <button type="button" class="ve-tbtn" data-cmd="justifyLeft" title="Align left">‚ü∏</button>
                <button type="button" class="ve-tbtn" data-cmd="justifyCenter" title="Align center">‚â°</button>
                <button type="button" class="ve-tbtn" data-cmd="justifyRight" title="Align right">‚üπ</button>
                <button type="button" class="ve-tbtn" data-cmd="justifyFull" title="Justify">‚ò∞</button>
              </div>
              <div class="ve-toolbar-group">
                <button type="button" class="ve-tbtn" data-cmd="insertUnorderedList" title="Bulleted list">‚Ä¢ List</button>
                <button type="button" class="ve-tbtn" data-cmd="insertOrderedList" title="Numbered list">1. List</button>
                <button type="button" class="ve-tbtn" data-cmd="outdent" title="Outdent">‚á§</button>
                <button type="button" class="ve-tbtn" data-cmd="indent" title="Indent">‚á•</button>
              </div>
              <div class="ve-toolbar-group">
                <button type="button" class="ve-tbtn" data-action="link" title="Insert/edit link">Link</button>
                <button type="button" class="ve-tbtn" data-action="image" title="Insert image by URL">Image</button>
                <button type="button" class="ve-tbtn" data-action="table" title="Insert table">Table</button>
              </div>
              <div class="ve-toolbar-group">
                <button type="button" class="ve-tbtn" data-action="removeformat" title="Remove formatting">Clear</button>
                <button type="button" class="ve-tbtn" id="veCodeToggleBtn" title="Toggle HTML source">HTML</button>
              </div>
            </div>

            <div class="ve-editor-wrap">
              <div id="veRichEditor" class="ve-rich-editor" contenteditable="true" spellcheck="true" aria-label="Rich text editor"></div>
              <textarea id="veSourceEditor" class="ve-source-editor" spellcheck="false" aria-label="HTML source editor" style="display:none"></textarea>
            </div>
          </div>
        </div>


        <div class="ve-pane">
          <div class="ve-pane-head">
            <div class="small-muted">Live email preview</div>
            <div class="small-muted">Changes update automatically</div>
          </div>
          <iframe id="vePreviewFrame" class="ve-preview-frame" title="Visual editor preview"></iframe>
        </div>
      </div>
    </div>

    <div class="ve-footer">
      <div class="ve-status" id="veStatus">Tip: edit text, links, images and tables. Keep structure tables intact for best Outlook rendering.</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" type="button" id="veCancelBtn">Cancel</button>
        <button class="btn btn-primary" type="button" id="veApplyBtn">Apply to template</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Enhanced Visual Editor Panel -->
<div id="visualEditorPanel">
  <div class="ve-header">
    <div class="ve-header-title">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/></svg>
      Visual Editor
    </div>
    <div class="ve-header-actions">
      <button class="btn" id="veRefreshPreviewBtn" type="button">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
        Refresh
      </button>
      <button class="btn btn-primary" id="veApplyChangesBtn" type="button">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
        Apply Changes
      </button>
      <button class="btn" id="veCloseEditorBtn" type="button">
        <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        Close
      </button>
    </div>
  </div>

  <div class="ve-main">
    <div class="ve-sidebar">
      <div class="ve-sidebar-header">
        <h3>Sections & Articles</h3>
        <p>Drag to reorder sections and articles. Click to edit.</p>
      </div>
      <div class="ve-sidebar-content" id="veSectionsList"></div>
    </div>

    <div class="ve-preview">
      <div class="ve-preview-header">
        <h3>Preview</h3>
        <div class="controls-row">
          <label style="display:flex;align-items:center;gap:6px;font-size:12px;cursor:pointer;padding:4px 8px;border-radius:6px;background:#f1f5f9">
            <input type="checkbox" id="veLiveEditToggle" style="margin:0">
            <span>Live Edit</span>
          </label>
          <label style="font-size:12px;color:var(--muted)">Zoom</label>
          <input type="range" id="veZoomRange" min="0.5" max="1.5" step="0.1" value="0.8" style="width:100px">
        </div>
      </div>
      <div id="veLiveEditHint" style="display:none;background:#dbeafe;color:#1e40af;padding:8px 16px;font-size:12px;border-bottom:1px solid #93c5fd">
        <strong>Live Edit Mode:</strong> Click on any title or text in the preview to edit it directly. Press Enter or click outside to save.
      </div>
      <div class="ve-preview-content">
        <div class="ve-preview-frame-wrap">
          <iframe id="vePreviewFrameNew" class="ve-preview-frame" title="Email preview"></iframe>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quick Edit Modal -->
<div class="ve-quick-edit" id="veQuickEditModal">
  <div class="ve-quick-edit-card">
    <div class="ve-quick-edit-header">
      <h3 id="veQuickEditTitle">Edit Article</h3>
      <button class="ve-quick-edit-close" id="veQuickEditClose" type="button">&times;</button>
    </div>
    <div class="ve-quick-edit-body">
      <div class="ve-quick-edit-field">
        <label for="veEditTitle">Title</label>
        <input type="text" id="veEditTitle" placeholder="Article title">
      </div>
      <div class="ve-quick-edit-field">
        <label for="veEditPreview">Summary / Preview text</label>
        <textarea id="veEditPreview" placeholder="Article summary or preview text"></textarea>
      </div>
      <div class="ve-quick-edit-field">
        <label for="veEditComment">Comment / Note</label>
        <textarea id="veEditComment" placeholder="Your comment or editorial note (optional)"></textarea>
      </div>
      <div class="ve-quick-edit-field">
        <label for="veEditLink">Link URL</label>
        <input type="url" id="veEditLink" placeholder="https://...">
      </div>
      <div class="ve-quick-edit-field">
        <label for="veEditImage">Image URL</label>
        <div style="display:flex;gap:8px;align-items:flex-start">
          <div style="flex:1">
            <input type="url" id="veEditImage" placeholder="https://... (paste image URL or upload)">
            <div class="hint" style="margin-top:4px">Used for featured articles. Leave empty to use article's original image.</div>
          </div>
          <label class="btn" style="cursor:pointer;flex-shrink:0" for="veImageUpload">
            <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Upload
          </label>
          <input type="file" id="veImageUpload" accept="image/*" style="display:none">
        </div>
        <div id="veImagePreview" style="margin-top:8px;display:none">
          <img id="veImagePreviewImg" style="max-width:200px;max-height:120px;border-radius:8px;border:1px solid var(--border)">
          <button type="button" class="btn" id="veImageRemove" style="margin-left:8px;padding:4px 8px;font-size:12px">Remove</button>
        </div>
      </div>
      <div class="ve-quick-edit-field">
        <label for="veEditSection">Section</label>
        <select id="veEditSection"></select>
      </div>
      <div class="ve-quick-edit-field">
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="veEditFeatured"> Mark as Featured (larger display with image)
        </label>
      </div>
    </div>
    <div class="ve-quick-edit-footer">
      <button class="btn" id="veQuickEditCancel" type="button">Cancel</button>
      <button class="btn btn-primary" id="veQuickEditSave" type="button">Save Changes</button>
    </div>
  </div>
</div>

<script>
// ============================ STATE ============================
let allArticles = [];
let htmlCode = "";
let discoveredTags = [];

let tagCounts = new Map(); // lowercased tag -> count across items (for smarter section selection)
let canonicalTagByLower = new Map(); // lowercased tag -> canonical label (preserves casing)

const PASTEL = [
  {name:"Neutral (white)", hex:"#ffffff", accent:"#475569"},
  {name:"Slate mist",      hex:"#f8fafc", accent:"#475569"},
  {name:"Sky blue",        hex:"#eff6ff", accent:"#2563eb"},
  {name:"Indigo",          hex:"#eef2ff", accent:"#4f46e5"},
  {name:"Violet",          hex:"#f5f3ff", accent:"#7c3aed"},
  {name:"Purple",          hex:"#faf5ff", accent:"#9333ea"},
  {name:"Rose pink",       hex:"#fff1f2", accent:"#e11d48"},
  {name:"Coral",           hex:"#fff7ed", accent:"#ea580c"},
  {name:"Amber gold",      hex:"#fffbeb", accent:"#d97706"},
  {name:"Lime green",      hex:"#f7fee7", accent:"#65a30d"},
  {name:"Emerald",         hex:"#ecfdf5", accent:"#059669"},
  {name:"Teal",            hex:"#f0fdfa", accent:"#0d9488"},
  {name:"Cyan",            hex:"#ecfeff", accent:"#0891b2"},
  {name:"Stone",           hex:"#fafaf9", accent:"#57534e"},
  {name:"Warm gray",       hex:"#f5f5f4", accent:"#78716c"}
];


const OUTLOOK_BASE_PX = 920; // Outlook-friendly base width for the email container

const config = {
  // Feed
  rssUrl: "",
  mappingMode: "auto",
  daysBack: 0,
  limitItems: 0,
  feedSource: "url",
  feedXml: "",

  // Content & layout
  headerText: "", headerSub: "", headerColor:"#ffffff", dateFormat: "yyyy-MM-dd", issueNumber: "",
  containerPct: 100, baseFontPx: 15, lineHeight: 1.5, linkStyle: "blue",
  fontFamily: "aptos", customFontFamily: "",
  articleTitlePx: 12, articleBodyPx: 10, linkFontPx: 10,
  theme: "clean",
  articlePresentation: "editorial", summaryWords: 0, commentDisplay: "auto", commentStyle: "callout",
  featuredImageWidthPx: 260, imageShape: "rect", imageRadiusPx: 10,
  columns: 1,

  // ToC & sections
  includeToc: true, tocPreset: "badges", tocStyle: "linked",
  tagOverrides: {}, sectionOrder: [],

  // UI
  zoom: 1.0, uiMode: "simple", dock: "right"
};
// Snapshot defaults for reset/import (safe deep clone)
const DEFAULT_CONFIG = JSON.parse(JSON.stringify(config));

// ============================ HELPERS ============================
const $ = (id)=>document.getElementById(id);
const esc = (s)=>String(s==null?"":s).replace(/[&<>"]/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));

const FONT_STACKS = {
  aptos: "Aptos,'Aptos Display','Segoe UI',Calibri,Arial,sans-serif",
  segoe: "'Segoe UI',Calibri,Arial,sans-serif",
  calibri: "Calibri,'Segoe UI',Arial,sans-serif",
  arial: "Arial,'Segoe UI',Calibri,sans-serif",
  verdana: "Verdana,Arial,sans-serif",
  georgia: "Georgia,'Times New Roman',serif",
  times: "'Times New Roman',Times,serif"
};
function sanitizeFontStack(s){
  // Strip characters that can break inline styles; keep commas/quotes for CSS.
  return String(s||"").replace(/[<>]/g,"").replace(/[\r\n]/g," ").trim();
}
function getFontStack(){
  if(config && config.fontFamily === "custom"){
    const v = sanitizeFontStack(config.customFontFamily);
    return v || FONT_STACKS.aptos;
  }
  const key = (config && typeof config.fontFamily === "string") ? config.fontFamily : "aptos";
  return FONT_STACKS[key] || FONT_STACKS.aptos;
}

function getPrimaryFontName(){
  const stack = getFontStack();
  const first = String(stack || "").split(",")[0].trim();
  return first.replace(/^['"]|['"]$/g,"");
}
function msoFontFamilyCSS(){
  const f = getPrimaryFontName() || "Aptos";
  return `mso-ascii-font-family:${f};mso-ansi-font-family:${f};mso-hansi-font-family:${f};mso-bidi-font-family:${f};`;
}
function pxToPt(px){
  const n = parseFloat(px);
  if(!isFinite(n)) return "0.0";
  return (n*0.75).toFixed(1);
}
function msoFontSizeCSS(px){
  const pt = pxToPt(px);
  return `mso-ansi-font-size:${pt}pt;mso-bidi-font-size:${pt}pt;`;
}

function msoFontSizeCSSExact(px){
  let p = parseFloat(px);
  if(!isFinite(p)) p = 0;
  p = Math.max(6, Math.min(96, Math.round(p)));
  return `mso-ansi-font-size:${p}pt;mso-bidi-font-size:${p}pt;`;
}

function slugify(s){ return String(s||"").toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,""); }
function setStatus(t){ const el=$("status"); if(el) el.textContent=t; }
function save(){
  try{
    // Avoid persisting large pasted XML payloads (can exceed localStorage quotas)
    const cfg = Object.assign({}, config);
    if(cfg.feedSource === "paste") cfg.feedSource = "url";
    cfg.feedXml = "";
    localStorage.setItem("tg42", JSON.stringify({config: cfg, allArticles}));
  }catch(e){}
}
function load(){
  try{
    const o=JSON.parse(localStorage.getItem("tg42")||"{}");
    if(o.config){ Object.assign(config, o.config); }
    normalizeConfig();
    if(Array.isArray(o.allArticles)){ allArticles = o.allArticles; rehydrateArticles(); }
  }catch(e){
    console.warn("Failed to load saved state", e);
  }
}
function safeDate(s){ if(!s) return null; const d=new Date(s); return isNaN(d)? null : d; }
function rehydrateArticles(){
  allArticles = (allArticles || []).map(a=>{
    if(!a) return a;
    const out = Object.assign({}, a);

    if(out.pubDate && !(out.pubDate instanceof Date)){
      out.pubDate = safeDate(out.pubDate);
    }

    // normalize category & soften URLs even for saved state (prevents broken columns from long links)
    out.category = normalizeTagName(out.category || "Other") || "Other";
    if(Array.isArray(out.tags)) out.tags = out.tags.map(normalizeTagName).filter(Boolean);
    out.preview = softenLongUrls(String(out.preview || ""));
    out.comment = softenLongUrls(String(out.comment || ""));

    if(typeof out.include !== "boolean") out.include = !!out.include;
    if(typeof out.featured !== "boolean") out.featured = !!out.featured;
    return out;
  });
}
function debounce(fn,ms){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }
function clampInt(v,min,max){ v=parseInt(v,10)||min; if(v<min)v=min; if(v>max)v=max; return v; }

function normalizeConfig(){
  config.containerPct = clampInt(config.containerPct,60,120);
  config.baseFontPx = clampInt(config.baseFontPx,12,18);
  config.lineHeight = Math.max(1.1, Math.min(1.8, parseFloat(config.lineHeight)||1.5));
  
  // Feed source
  if(typeof config.feedSource !== "string") config.feedSource = "url";
  if(config.feedSource !== "url" && config.feedSource !== "paste") config.feedSource = "url";
  if(typeof config.feedXml !== "string") config.feedXml = "";
  
  // Typography controls
  if(config.articleTitlePx == null) config.articleTitlePx = 12;
  if(config.articleBodyPx == null) config.articleBodyPx = 10;
  if(config.linkFontPx == null) config.linkFontPx = 10;
  // Typography migration: previous defaults used 11px for body/link; adjust to 10px for correct hierarchy.
  // Do not override user-custom sizes except when they match the previous defaults.
  if(config.__typographyFixV !== 1){
    if(config.articleBodyPx === 11) config.articleBodyPx = 10;
    if(config.linkFontPx === 11) config.linkFontPx = 10;
    config.__typographyFixV = 1;
  }

  config.articleTitlePx = clampInt(config.articleTitlePx,10,18);
  config.articleBodyPx = clampInt(config.articleBodyPx,9,16);
  config.linkFontPx = clampInt(config.linkFontPx,9,16);

  if(typeof config.fontFamily !== "string") config.fontFamily = "aptos";
  const fontPresets = ["aptos","segoe","calibri","arial","verdana","georgia","times","custom"];
  if(!fontPresets.includes(config.fontFamily)) config.fontFamily = "aptos";
  if(typeof config.customFontFamily !== "string") config.customFontFamily = "";
config.featuredImageWidthPx = clampInt(config.featuredImageWidthPx,140,420);
  config.imageRadiusPx = clampInt(config.imageRadiusPx,0,48);
  config.columns = Math.max(1, Math.min(3, parseInt(config.columns,10)||1));

  const themes = ["cards","clean","divider","stripe"];
  if(!themes.includes(config.theme)) config.theme = "cards";

  const pres = ["standard","editorial","compact"];
  if(!pres.includes(config.articlePresentation)) config.articlePresentation = "editorial";

  config.summaryWords = Math.max(0, Math.min(160, parseInt(config.summaryWords,10)||0));

  const cdisp = ["auto","hide","show"];
  if(!cdisp.includes(config.commentDisplay)) config.commentDisplay = "auto";

  const csty = ["callout","takeaways","sidenote","quote","italic","plain"];
  if(!csty.includes(config.commentStyle)) config.commentStyle = "callout";

  const linkStyles = ["blue","gray","accent"];
  if(!linkStyles.includes(config.linkStyle)) config.linkStyle = "blue";

  const tocPresets = ["minimal","numbered","badges","two-col"];
  if(!tocPresets.includes(config.tocPreset)) config.tocPreset = "badges";

  const tocStyles = ["linked","plain"];
  if(!tocStyles.includes(config.tocStyle)) config.tocStyle = "linked";

  const shapes = ["rect","rounded","circle"];
  if(!shapes.includes(config.imageShape)) config.imageShape = "rect";

  config.uiMode = (config.uiMode==="advanced") ? "advanced" : "simple";
  config.dock = (config.dock==="bottom") ? "bottom" : "right";
  config.zoom = Math.max(0.75, Math.min(1.5, parseFloat(config.zoom)||1));

  // Feed settings
  config.daysBack = Math.max(0, parseInt(config.daysBack,10)||0);
  config.limitItems = Math.max(0, parseInt(config.limitItems,10)||0);

  const mappingModes = ["auto","descPreview_contentNote","contentPreview_descNote","descOnly","contentOnly"];
  if(!mappingModes.includes(config.mappingMode)) config.mappingMode = "auto";

  if(typeof config.rssUrl !== "string") config.rssUrl = "";

  // Header meta
  if(typeof config.issueNumber !== "string") config.issueNumber = (config.issueNumber==null ? "" : String(config.issueNumber));

  // --- Migration for requested section name fix (keeps prior colors/order if saved) ---
  const old1 = "Surveillance by Design &amp; by Default";
  const old2 = "Surveillance by Design & by Default";
  const neu  = "Surveillance by Design and by Default";
  if(config.tagOverrides && (config.tagOverrides[old1] || config.tagOverrides[old2])){
    const merged = Object.assign({}, config.tagOverrides[old1]||{}, config.tagOverrides[old2]||{});
    config.tagOverrides[neu] = Object.assign({}, merged, config.tagOverrides[neu]||{});
    delete config.tagOverrides[old1];
    delete config.tagOverrides[old2];
  }
  if(Array.isArray(config.sectionOrder) && config.sectionOrder.length){
    config.sectionOrder = config.sectionOrder.map(t => (t===old1 || t===old2) ? neu : t);
  }
}

function borderFor(bg){
  const b=(bg||"").toLowerCase();

  // Prefer palette-defined accents (newer, more coherent color options)
  const hit = (Array.isArray(PASTEL) ? PASTEL : []).find(c => (c.hex||"").toLowerCase()===b && c.accent);
  if(hit) return hit.accent;

  // Backward-compat mappings for older stored background colors
  switch(b){
    case "#eff6ff": return "#3b82f6";
    case "#fef2f2": return "#dc2626";
    case "#fef3c7": return "#f59e0b";
    case "#f0fdf4": return "#10b981";
    case "#faf5ff": return "#a855f7";
    case "#fff1f2": return "#f43f5e";
    case "#ecfeff": return "#06b6d4";
    case "#fef9c3": return "#f59e0b";
    case "#f5f3ff": return "#7c3aed";
    case "#f9fafb": return "#64748b";
    default: return "#c7d2fe";
  }
}
function upsertTag(tag, delta){ const ov=config.tagOverrides[tag]||{}; config.tagOverrides[tag]=Object.assign({}, ov, delta); save(); }

// HTML entity decode + strip tags safely
function cleanText(s){
  if(!s) return "";
  s = String(s).replace(/<!\[CDATA\[|\]\]>/g,"");
  const div = document.createElement("div");
  div.innerHTML = s; // decodes entities
  let t = (div.textContent || div.innerText || "").replace(/\s+/g," ").trim();
  return t;
}

// Prevent long unbroken URLs from breaking column widths in email clients
function softenLongUrls(text){
  const zw = "\u200B"; // zero-width space
  let s = String(text || "");
  if(!s || s.indexOf(zw) !== -1) return s;
  // insert break opportunities into URL-like tokens
  s = s.replace(/(https?:\/\/[^\s)]+|www\.[^\s)]+)/gi, (u)=>{
    return u.replace(/([\/\.\-\_\?\&\=\#%])/g, `$1${zw}`);
  });
  return s;
}

function truncateWords(text, maxWords){
  const n = parseInt(maxWords, 10) || 0;
  if(n <= 0) return String(text || "");
  const s = String(text || "").trim();
  if(!s) return "";
  const parts = s.split(/\s+/g);
  if(parts.length <= n) return s;
  return parts.slice(0, n).join(" ") + "‚Ä¶";
}


// Normalize tag/section labels (decode entities + apply requested name correction)
function normalizeTagName(raw){
  let t = cleanText(raw || "");
  if(!t) return "";
  // requested exact correction (case-insensitive match, canonical output)
  if(/surveillance by design\s*&\s*by default/i.test(t) || /surveillance by design\s*and\s*by default/i.test(t)){
    t = "Surveillance by Design and by Default";
  }
  return t;
}

// Extract tag candidates robustly across RSS/Atom variants (incl. Raindrop-style feeds)
function splitTagList(s){
  let v = String(s||"").trim();
  if(!v) return [];
  // remove common prefixes
  v = v.replace(/^(tags?|keywords?)\s*:\s*/i, "");

  // If the string uses hashtag-style encoding (#tag #multi word tag),
  // split on '#' markers while preserving spaces inside each tag.
  if(/#\S/.test(v)){
    const out = [];
    const re = /#([^#]+)/g;
    let m;
    while((m = re.exec(v))){
      const t = m[1].trim();
      if(t) out.push(t);
    }
    if(out.length) return out;
  }

  // Default: comma/semicolon/pipe/newline separated lists.
  return v
    .split(/[;,|\n\r]+/g)
    .map(t=>t.trim())
    .filter(Boolean);
}
function extractTagCandidates(item){
  const out = [];

  // Rare: custom feeds put tags into attributes
  try{
    if(item && item.attributes){
      Array.from(item.attributes).forEach(attr=>{
        const n = String(attr.name||"").toLowerCase();
        if(n.includes("tag") || n.includes("keyword")){
          const v = normalizeTagName(attr.value||"");
          if(v) out.push(...splitTagList(v));
        }
      });
    }
  }catch(e){}

  // Namespace-agnostic scan: match by localName so prefixes don't matter (e.g., dc:subject, media:keywords)
  const wanted = new Set(["category","subject","keywords","keyword","tag","tags","topic"]);
  item.querySelectorAll("*").forEach(el=>{
    const ln = String(el.localName || el.nodeName || "").toLowerCase();
    if(!wanted.has(ln)) return;

    const v = normalizeTagName(
      el.getAttribute("term") ||
      el.getAttribute("label") ||
      el.getAttribute("name")  ||
      el.textContent ||
      ""
    );

    if(v) out.push(...splitTagList(v));
  });

  // Dedupe (case-insensitive) while preserving order
  const seen = new Set();
  return out
    .map(t=>t.trim())
    .filter(Boolean)
    .filter(t=>{
      const k = t.toLowerCase();
      if(seen.has(k)) return false;
      seen.add(k);
      return true;
    });
}
function isNonSectionTag(t){
  const k = String(t||"").trim().toLowerCase();
  if(!k) return true;

  // If the user explicitly configured this tag as a section, never treat it as "non-section".
  try{
    const configured = []
      .concat(Array.isArray(config.sectionOrder) ? config.sectionOrder : [])
      .concat(Object.keys(config.tagOverrides || {}));
    for(const x of configured){
      const nx = normalizeTagName(x);
      if(nx && nx.toLowerCase() === k) return false;
    }
  }catch(e){}

  // Defensive: ignore URLs accidentally captured as tags
  if(/^https?:\/\//.test(k)) return true;

  // Feed/item-type categories (NOT topical tags). Raindrop-style feeds often emit these.
  // If you ever need one of these as an actual section, add it to Sections (order/colors) so it becomes "configured".
  if(/^(link|article|post|bookmark|item|entry)$/i.test(k)) return true;

  // Workflow / utility tags (commonly used in bookmarking)
  if(/^(to[-\s]?read|read[-\s]?later|later|inbox|starred|favorite|favourites|fav|archived|archive|uncategorized)$/i.test(k)) return true;

  // Sometimes feeds emit a platform marker; treat as non-section
  if(k === "raindrop" || k === "raindrop.io") return true;

  return false;
}
function choosePrimarySection(tags){
  const norm = (Array.isArray(tags)?tags:[])
    .map(normalizeTagName)
    .filter(Boolean);

  if(!norm.length) return "Other";

  // 1) Prefer tags that the user has configured (section order first, then overrides),
  // returning the canonical configured label (preserves casing so colors/order apply).
  const preferredRaw = []
    .concat(Array.isArray(config.sectionOrder)?config.sectionOrder:[])
    .concat(Object.keys(config.tagOverrides||{}));

  const preferred = [];
  const seenPref = new Set();
  preferredRaw.forEach(p=>{
    const canon = normalizeTagName(p);
    if(!canon) return;
    const k = canon.toLowerCase();
    if(seenPref.has(k)) return;
    seenPref.add(k);
    preferred.push(canon);
  });

  const normSet = new Set(norm.map(t=>t.toLowerCase()));
  for(const p of preferred){
    if(normSet.has(p.toLowerCase())) return p;
  }

  // 2) Choose the best "section tag" among the remaining tags.
  // Use a scoring model that prefers:
  //   - non-workflow tags
  //   - more specific tags (lower global frequency)
  //   - longer labels when tied (often more descriptive)
  const candidates = norm.filter(t=>!isNonSectionTag(t));
  if(!candidates.length){
    // Only generic / non-section tags were present (e.g., "link", "article") ‚Üí assign to Other.
    return "Other";
  }

  let best = candidates[0];
  let bestScore = null;

  candidates.forEach(t=>{
    const k = t.toLowerCase();
    const freq = (tagCounts && typeof tagCounts.get === "function" && tagCounts.get(k)) ? tagCounts.get(k) : 1;

    // Lower is better for freq; higher is better for length.
    const score = {
      freq: freq,
      len: t.length
    };

    if(bestScore === null){
      bestScore = score;
      best = t;
      return;
    }

    if(score.freq < bestScore.freq){
      bestScore = score;
      best = t;
      return;
    }
    if(score.freq === bestScore.freq && score.len > bestScore.len){
      bestScore = score;
      best = t;
      return;
    }
  });

  return best || candidates[0];
}


// ============================ MODE & DOCK ============================
function applyUIMode(){
  document.body.classList.toggle("simple", config.uiMode==="simple");
  if($("modeSimple")) $("modeSimple").classList.toggle("active", config.uiMode==="simple");
  if($("modeAdvanced")) $("modeAdvanced").classList.toggle("active", config.uiMode==="advanced");
}
function initUIMode(){
  if($("modeSimple")) $("modeSimple").onclick=()=>{config.uiMode="simple"; save(); applyUIMode();};
  if($("modeAdvanced")) $("modeAdvanced").onclick=()=>{config.uiMode="advanced"; save(); applyUIMode();};
  applyUIMode();
}
function applyDock(){ document.body.classList.toggle("dock-bottom", config.dock==="bottom"); if($("dockSelect")) $("dockSelect").value=config.dock; }
function bindDock(){ if($("dockSelect")) {$("dockSelect").onchange=()=>{ config.dock=$("dockSelect").value; save(); applyDock(); }; applyDock(); } }

// ============================ HEADER & TOC BIND ============================
function bindHeader(){
  if(!$("headerText")) return;
  $("headerText").value = config.headerText;
  $("headerSub").value = config.headerSub;
  if($("dateFormat")) $("dateFormat").value = config.dateFormat;
  $("headerColor").value = config.headerColor||"#ffffff";
  $("headerText").oninput=()=>{ config.headerText=$("headerText").value; queueBuild(); save(); };
  $("headerSub").oninput=()=>{ config.headerSub=$("headerSub").value; queueBuild(); save(); };
  if($("dateFormat")) $("dateFormat").oninput=()=>{ config.dateFormat=$("dateFormat").value; queueBuild(); save(); };
  $("headerColor").onchange=()=>{ config.headerColor=$("headerColor").value; queueBuild(); save(); };
  if($("issueNumber")){
    $("issueNumber").value = (config.issueNumber==null ? "" : String(config.issueNumber));
    $("issueNumber").oninput=()=>{ config.issueNumber=$("issueNumber").value; queueBuild(); save(); };
  }

}
function bindToc(){
  if(!$("includeToc")) return;
  $("includeToc").checked = !!config.includeToc;
  $("tocPreset").value = config.tocPreset;
  $("tocStyle").value = config.tocStyle;
  ["includeToc","tocPreset","tocStyle"].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.addEventListener("change", ()=>{
      if(id==="includeToc") config.includeToc=$("includeToc").checked;
      if(id==="tocPreset") config.tocPreset=$("tocPreset").value;
      if(id==="tocStyle") config.tocStyle=$("tocStyle").value;
      queueBuild(); save();
    });
  });
}

// ============================ LAYOUT ============================
function bindLayout(){
  if(!$("containerPct")) return;
  $("containerPct").value = config.containerPct;
  $("baseFontPx").value = config.baseFontPx;
  $("lineHeight").value = config.lineHeight;
  $("linkStyle").value = config.linkStyle;
  $("templateTheme").value = config.theme || "cards";
  $("articlePresentation").value = config.articlePresentation || "editorial";
  $("summaryWords").value = (config.summaryWords==null?0:config.summaryWords);
  $("commentDisplay").value = config.commentDisplay || "auto";
  $("commentStyle").value = config.commentStyle || "callout";
  $("featuredImageWidthPx").value = config.featuredImageWidthPx;
  $("imageShape").value = config.imageShape;
  $("imageRadiusPx").value = config.imageRadiusPx;

  
  // Typography controls
  if($("fontFamily")) $("fontFamily").value = config.fontFamily || "aptos";
  if($("customFontFamily")) $("customFontFamily").value = config.customFontFamily || "";
  if($("articleTitlePx")) $("articleTitlePx").value = (config.articleTitlePx==null?12:config.articleTitlePx);
  if($("articleBodyPx")) $("articleBodyPx").value = (config.articleBodyPx==null?10:config.articleBodyPx);
  if($("linkFontPx")) $("linkFontPx").value = (config.linkFontPx==null?10:config.linkFontPx);

  const applyFontUI = ()=>{
    const isCustom = (config.fontFamily === "custom");
    const row = $("customFontRow");
    if(row) row.style.display = isCustom ? "flex" : "none";
  };
  applyFontUI();


  const rebuildIfSafe = ()=>{
    // Do not overwrite the iframe while editing; apply styles live instead.
    if(typeof InlineEditor !== "undefined" && InlineEditor.enabled){
      applyTypographyLive();
      return;
    }
    // Apply immediately, then rebuild (debounced) for a clean, canonical export.
    applyTypographyLive();
    queueBuild();
  };

  if($("fontFamily")) $("fontFamily").onchange=()=>{ config.fontFamily=$("fontFamily").value; applyFontUI(); rebuildIfSafe(); save(); };
  if($("customFontFamily")) {
    $("customFontFamily").oninput=()=>{ config.customFontFamily=$("customFontFamily").value; if(config.fontFamily==="custom"){ rebuildIfSafe(); save(); } };
    $("customFontFamily").onchange=()=>{ config.customFontFamily=$("customFontFamily").value; if(config.fontFamily==="custom"){ rebuildIfSafe(); save(); } };
  }
  const bindNum = (id, min, max, key)=>{
    const el = $(id);
    if(!el) return;
    const handler = ()=>{
      config[key] = clampInt(el.value, min, max);
      el.value = String(config[key]);
      rebuildIfSafe();
      save();
    };
    el.oninput = handler;
    el.onchange = handler;
  };
  bindNum("articleTitlePx", 10, 18, "articleTitlePx");
  bindNum("articleBodyPx", 9, 16, "articleBodyPx");
  bindNum("linkFontPx", 9, 16, "linkFontPx");

  $("containerPct").oninput=()=>{ config.containerPct=clampInt($("containerPct").value,60,120); queueBuild(); save(); };
  $("baseFontPx").oninput=()=>{ config.baseFontPx=clampInt($("baseFontPx").value,12,18); queueBuild(); save(); };
  $("lineHeight").oninput=()=>{ config.lineHeight=parseFloat($("lineHeight").value)||1.5; queueBuild(); save(); };
  $("linkStyle").onchange=()=>{ config.linkStyle=$("linkStyle").value; queueBuild(); save(); };
  $("templateTheme").onchange=()=>{ config.theme=$("templateTheme").value; queueBuild(); save(); };
  $("articlePresentation").onchange=()=>{ config.articlePresentation=$("articlePresentation").value; queueBuild(); save(); };
  $("summaryWords").oninput=()=>{ config.summaryWords=Math.max(0, Math.min(160, parseInt($("summaryWords").value,10)||0)); $("summaryWords").value=String(config.summaryWords); queueBuild(); save(); };
  $("commentDisplay").onchange=()=>{ config.commentDisplay=$("commentDisplay").value; queueBuild(); save(); };
  $("commentStyle").onchange=()=>{ config.commentStyle=$("commentStyle").value; queueBuild(); save(); };
  $("featuredImageWidthPx").oninput=()=>{ config.featuredImageWidthPx=clampInt($("featuredImageWidthPx").value,140,420); queueBuild(); save(); };
  $("imageShape").onchange=()=>{ config.imageShape=$("imageShape").value; queueBuild(); save(); };
  $("imageRadiusPx").oninput=()=>{ config.imageRadiusPx=clampInt($("imageRadiusPx").value,0,48); queueBuild(); save(); };

  // Columns buttons (ensure UI reflects persisted selection)
  const colsNow = Math.max(1, Math.min(3, parseInt(config.columns,10)||1));
  config.columns = colsNow;

  document.querySelectorAll("#columnsGroup .btn").forEach(b=>{
    const n = parseInt(b.getAttribute("data-cols"),10)||1;
    b.classList.toggle("active", n===colsNow);
    b.onclick=()=>{
      document.querySelectorAll("#columnsGroup .btn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      config.columns = Math.max(1, Math.min(3, parseInt(b.getAttribute("data-cols"),10)||1));
      queueBuild(); save();
    };
  });
}
function bindFilters(){
  const db = $("daysBack");
  const li = $("limitItems");
  const normVal = (v)=>Math.max(0, parseInt(v||"0",10) || 0);

  if(db){
    const v0 = normVal(config.daysBack);
    db.value = String(v0);
    db.addEventListener("input", ()=>{
      const v = normVal(db.value);
      db.value = String(v);
      config.daysBack = v;
      save();
      queueBuild();
      renderArticleList();
    });
  }

  if(li){
    const v0 = normVal(config.limitItems);
    li.value = String(v0);
    li.addEventListener("input", ()=>{
      const v = normVal(li.value);
      li.value = String(v);
      config.limitItems = v;
      save();
      queueBuild();
      renderArticleList();
    });
  }
}

function bindFeedControls(){
  const urlEl = $("rssUrl");
  if(urlEl){
    urlEl.value = (typeof config.rssUrl === "string") ? config.rssUrl : "";
    urlEl.addEventListener("input", ()=>{
      config.rssUrl = urlEl.value;
      save();
    });
    urlEl.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){
        e.preventDefault();
        parseRSS();
      }
    });
  }

  const srcEl = $("feedSource");
  const xmlEl = $("feedXml");
  const xmlRow = $("feedPasteRow");

  const applyFeedSourceUI = ()=>{
    const mode = (srcEl ? (srcEl.value||"url") : (config.feedSource||"url"));
    if(xmlRow) xmlRow.style.display = (mode==="paste") ? "block" : "none";
  };

  if(srcEl){
    srcEl.value = config.feedSource || "url";
    srcEl.addEventListener("change", ()=>{
      config.feedSource = srcEl.value || "url";
      save();
      applyFeedSourceUI();
    });
  }

  if(xmlEl){
    xmlEl.value = (typeof config.feedXml === "string") ? config.feedXml : "";
    xmlEl.addEventListener("input", ()=>{
      config.feedXml = xmlEl.value;
      // Not persisted to localStorage (may be large).
    });
  }

  applyFeedSourceUI();

  const mapEl = $("mappingMode");
  if(mapEl){
    mapEl.value = config.mappingMode || "auto";
    mapEl.addEventListener("change", ()=>{
      config.mappingMode = mapEl.value || "auto";
      save();
    });
  }
}

// ============================ CURATE LIST (ADVANCED) ============================
function renderArticleList(){
  const el = $("articleList"); if(!el) return;
  const list = getFiltered();
  const rows = list.map(a=>{
    return `<div class="article-item" draggable="true" data-id="${a.id}" data-cat="${esc(a.category||'Other')}">
      <span class="drag" title="Drag to reorder" role="img" aria-label="Drag handle">‚â°</span>
      <input type="checkbox" data-field="include" data-id="${a.id}" ${a.include?"checked":""} title="Include">
      <div><div class="title">${esc(a.title||"(no title)")}</div><div class="hint">${esc(a.category||"Other")}${a.featured?" ¬∑ ‚òÖ Featured":""}</div></div>
      <div><span class="star" data-id="${a.id}" title="Toggle featured" role="img" aria-label="Toggle featured star">‚òÖ</span></div>
    </div>`;
  }).join("");
  el.innerHTML = rows || '<div class="hint">No items yet. Generate a feed first.</div>';

  // include toggle
  el.querySelectorAll('input[type="checkbox"][data-field="include"]').forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const id=parseInt(cb.getAttribute("data-id"),10); const a=allArticles.find(x=>x.id===id); if(a){ a.include=cb.checked; save(); queueBuild(); }
    });
  });
  // featured toggle
  el.querySelectorAll(".star").forEach(s=>{
    s.addEventListener("click", ()=>{
      const id=parseInt(s.getAttribute("data-id"),10); const a=allArticles.find(x=>x.id===id); if(a){ a.featured=!a.featured; save(); queueBuild(); renderArticleList(); }
    });
  });
  // drag-drop only within same section
  let dragId=null, dragCat=null;
  el.querySelectorAll(".article-item").forEach(row=>{
    row.addEventListener("dragstart", (ev)=>{ dragId=parseInt(row.getAttribute("data-id"),10); dragCat=row.getAttribute("data-cat"); try{ ev.dataTransfer.setData("text/plain", String(dragId)); }catch(e){} });
    row.addEventListener("dragover", (ev)=>{ ev.preventDefault(); row.classList.toggle("drag-over", (row.getAttribute("data-cat")===dragCat)); });
    row.addEventListener("dragleave", ()=>row.classList.remove("drag-over"));
    row.addEventListener("drop", (ev)=>{
      ev.preventDefault(); row.classList.remove("drag-over");
      const targetId=parseInt(row.getAttribute("data-id"),10); const targetCat=row.getAttribute("data-cat");
      if(!dragId || dragCat!==targetCat) return;
      const inCat = allArticles.filter(a=>a.category===dragCat);
      const order = inCat.map(a=>a.id);
      const from=order.indexOf(dragId), to=order.indexOf(targetId);
      if(from<0||to<0||from===to) return;
      order.splice(to,0,order.splice(from,1)[0]);
      order.forEach((id,idx)=>{ const a=allArticles.find(x=>x.id===id); if(a) a.sortIndexCat=idx; });
      save(); queueBuild(); renderArticleList();
    });
  });
}

// ============================ SECTIONS BOARD ============================
function populateSectionsBoard(){
  const el=$("sectionsList"); if(!el) return;
  const tags = discoveredTags.slice();
  const order = (config.sectionOrder && config.sectionOrder.length) ? config.sectionOrder.filter(t=>tags.includes(t)).concat(tags.filter(t=>!config.sectionOrder.includes(t))) : tags;
  const rows = order.map(tag=>{
    const ov=config.tagOverrides[tag]||{}; const bg=colorFor(tag); const border=borderFor(bg); const emoji=ov.emoji||"";
    const options = PASTEL.map(c=>`<option value="${c.hex}"${bg===c.hex?" selected":""}>${c.name}</option>`).join("");
    return `<div class="section-row" draggable="true" data-tag="${esc(tag)}">
      <span class="drag" title="Drag to reorder">‚â°</span>
      <div><span class="swatch" style="background:${bg}"></span><strong>${esc(tag)}</strong> ${emoji?esc(emoji):""}</div>
      <div><span class="toc-badge-mini" style="background:${bg};border-color:${border}">${esc(tag)}</span></div>
      <div><label style="font-weight:600;">Color</label><select class="sec-color" data-tag="${esc(tag)}">${options}</select></div>
      <div><label style="font-weight:600;">Emoji</label><input type="text" class="sec-emoji" data-tag="${esc(tag)}" value="${esc(emoji)}" placeholder="e.g., üîí"></div>
    </div>`;
  }).join("");
  el.innerHTML = rows || '<div class="hint">No sections yet. Generate a feed first.</div>';

  // Color change
  el.querySelectorAll(".sec-color").forEach(sel=>{
    sel.onchange=()=>{ const tag=sel.getAttribute("data-tag"); upsertTag(tag,{color: sel.value}); queueBuild(); populateSectionsBoard(); };
  });
  // Emoji change
  el.querySelectorAll(".sec-emoji").forEach(inp=>{
    inp.oninput=()=>{ const tag=inp.getAttribute("data-tag"); upsertTag(tag,{emoji: inp.value}); queueBuild(); populateSectionsBoard(); };
  });
  // Drag reorder
  let dragTag=null;
  el.querySelectorAll(".section-row").forEach(r=>{
    r.addEventListener("dragstart",(ev)=>{ dragTag=r.getAttribute("data-tag"); try{ ev.dataTransfer.setData("text/plain", dragTag); }catch(e){} ev.dataTransfer.effectAllowed="move"; });
    r.addEventListener("dragover",(ev)=>{ ev.preventDefault(); r.classList.add("drag-over"); });
    r.addEventListener("dragleave",()=> r.classList.remove("drag-over"));
    r.addEventListener("drop",(ev)=>{
      ev.preventDefault(); r.classList.remove("drag-over");
      const targetTag=r.getAttribute("data-tag"); if(!dragTag || dragTag===targetTag) return;
      const cur = Array.from(el.querySelectorAll(".section-row")).map(x=>x.getAttribute("data-tag")).filter(Boolean);
      const from=cur.indexOf(dragTag), to=cur.indexOf(targetTag);
      if(from<0||to<0) return;
      cur.splice(to,0, cur.splice(from,1)[0]);
      config.sectionOrder=cur; save(); queueBuild(); populateSectionsBoard();
    });
  });
}

// ============================ PREVIEW / WYSIWYG ============================
function refreshPreview(opts){
  const frame = $("previewFrame");
  if(!frame) return;

  const o = opts || {};
  const force = !!o.force;
  const raw = !!o.raw;

  // When editing directly in the preview, avoid overwriting the iframe and losing in-progress edits.
  if(typeof InlineEditor !== "undefined" && InlineEditor.enabled && !force){
    return;
  }

  let src = htmlCode;
  if(!raw && $("outlookPreviewToggle")?.checked) src = outlookSafeTransform(src);

  frame.srcdoc = src;
  frame.onload = ()=>{
    applyZoom(config.zoom || 1);
    if(frame && frame.contentDocument){ applyTypographyToDoc(frame.contentDocument); }
    if(typeof InlineEditor !== "undefined" && InlineEditor.enabled){
      InlineEditor.attachToFrame();
    }
  };
}
function applyZoom(val){ const wrap=$("previewWrap"); if(!wrap) return; wrap.style.transformOrigin="top left"; wrap.style.transform=`scale(${val})`; }

// ============================ TYPOGRAPHY (LIVE APPLY) ============================
// These helpers make font dropdowns and size controls apply immediately, even while the inline editor is enabled.
function applyTypographyToDoc(doc){
  try{
    if(!doc) return;
    const fontStack = getFontStack();
    const base = clampInt(config.baseFontPx,12,18);
    const lh = Math.max(1.1, Math.min(1.8, parseFloat(config.lineHeight)||1.5));
    const titlePx = clampInt(config.articleTitlePx,10,18);
    const bodyPx  = clampInt(config.articleBodyPx,9,16);
    const linkPx  = clampInt(config.linkFontPx,9,16);
    const secPx   = Math.max(18, Math.min(22, base + 5));

    if(doc.body){
      doc.body.style.fontFamily = fontStack;
      doc.body.style.fontSize = base + "px";
      doc.body.style.lineHeight = String(lh);
    }

    // Update any elements that explicitly set a font-family inline (e.g., badges)
    doc.querySelectorAll('[style*="font-family"]').forEach(el=>{
      try{ el.style.fontFamily = fontStack; }catch(e){}
    });

    doc.querySelectorAll('[data-nl="section-title"]').forEach(el=>{ try{ el.style.fontSize = secPx + "px"; }catch(e){} });
    doc.querySelectorAll('[data-nl="article-title"]').forEach(el=>{ try{ el.style.fontSize = titlePx + "px"; }catch(e){} });
    doc.querySelectorAll('[data-nl="article-body"]').forEach(el=>{ try{ el.style.fontSize = bodyPx + "px"; }catch(e){} });
    doc.querySelectorAll('[data-nl="article-link"]').forEach(el=>{ try{ el.style.fontSize = linkPx + "px"; }catch(e){} });
  }catch(e){
    console.warn("applyTypographyToDoc failed", e);
  }
}

function applyTypographyToHtmlString(src){
  try{
    let s = String(src || "");
    const fontStack = getFontStack();
    const msoFont = msoFontFamilyCSS();

    const base = clampInt(config.baseFontPx,12,18);
    const lh = Math.max(1.1, Math.min(1.8, parseFloat(config.lineHeight)||1.5));
    const titlePx = clampInt(config.articleTitlePx,10,18);
    const bodyPx  = clampInt(config.articleBodyPx,9,16);
    const linkPx  = clampInt(config.linkFontPx,9,16);
    const secPx   = Math.max(18, Math.min(22, base + 5));

    const ensureMsoFontFamily = (st)=>{
      // Remove any existing MSO font-family declarations, then append the canonical set.
      st = st.replace(/mso-(?:ascii|ansi|hansi|bidi)-font-family:\s*[^;"]+;?/ig, "");
      const sep = st && !st.trim().endsWith(";") ? ";" : "";
      return st + sep + msoFont;
    };

    const ensureMsoFontSize = (st, px)=>{
      const pt = pxToPt(px);
      st = st.replace(/mso-ansi-font-size:\s*[\d.]+pt/ig, `mso-ansi-font-size:${pt}pt`);
      st = st.replace(/mso-bidi-font-size:\s*[\d.]+pt/ig, `mso-bidi-font-size:${pt}pt`);
      if(!/mso-ansi-font-size:/i.test(st)) st += `;mso-ansi-font-size:${pt}pt`;
      if(!/mso-bidi-font-size:/i.test(st)) st += `;mso-bidi-font-size:${pt}pt`;
      return st;
    };

    // Update <body style="..."> typography (Outlook/Word engine ignores inherited typography unless inline)
    s = s.replace(/(<body\b[^>]*\bstyle=")([^"]*)(")/i, (m, pre, style, post)=>{
      let st = style;

      st = st.replace(/font-size:\s*\d+px/ig, `font-size:${base}px`);
      if(!/font-size:/i.test(st)) st += `;font-size:${base}px`;
      st = ensureMsoFontSize(st, base);

      st = st.replace(/line-height:\s*[\d.]+/ig, `line-height:${lh}`);
      if(!/line-height:/i.test(st)) st += `;line-height:${lh}`;

      st = st.replace(/font-family:\s*[^;"]+/ig, `font-family:${fontStack}`);
      if(!/font-family:/i.test(st)) st += `;font-family:${fontStack}`;
      st = ensureMsoFontFamily(st);

      return pre + st + post;
    });

    // Keep inline font-family aligned everywhere
    s = s.replace(/font-family:\s*[^;"]+/ig, `font-family:${fontStack}`);

    // Keep Outlook/Word MSO font-family declarations aligned with the primary font
    const primary = getPrimaryFontName() || "Aptos";
    s = s.replace(/mso-ascii-font-family:\s*[^;"]+/ig, `mso-ascii-font-family:${primary}`);
    s = s.replace(/mso-ansi-font-family:\s*[^;"]+/ig, `mso-ansi-font-family:${primary}`);
    s = s.replace(/mso-hansi-font-family:\s*[^;"]+/ig, `mso-hansi-font-family:${primary}`);
    s = s.replace(/mso-bidi-font-family:\s*[^;"]+/ig, `mso-bidi-font-family:${primary}`);

    const replaceSize = (key, px)=>{
      const pt = (String(key).indexOf('article-')===0) ? String(px) : pxToPt(px);

      // Replace existing font-size
      const re = new RegExp(`(<[^>]*data-nl=\\"${key}\\"[^>]*style=\\"[^\\"]*?)font-size:\\s*\\d+px`, "ig");
      s = s.replace(re, `$1font-size:${px}px`);

      // Replace existing MSO sizes
      const reMsoA = new RegExp(`(<[^>]*data-nl=\\"${key}\\"[^>]*style=\\"[^\\"]*?)mso-ansi-font-size:\\s*[\\d.]+pt`, "ig");
      s = s.replace(reMsoA, `$1mso-ansi-font-size:${pt}pt`);
      const reMsoB = new RegExp(`(<[^>]*data-nl=\\"${key}\\"[^>]*style=\\"[^\\"]*?)mso-bidi-font-size:\\s*[\\d.]+pt`, "ig");
      s = s.replace(reMsoB, `$1mso-bidi-font-size:${pt}pt`);

      // If missing, append font-size + MSO sizes into style=""
      const re2 = new RegExp(`(<[^>]*data-nl=\\"${key}\\"[^>]*style=\\")([^\\"]*)(")`, "ig");
      s = s.replace(re2, (m, pre, st, post)=>{
        let out = st;

        if(!/font-size:/i.test(out)){
          const sep = out && !out.trim().endsWith(";") ? ";" : "";
          out = out + sep + `font-size:${px}px;`;
        }
        if(!/mso-ansi-font-size:/i.test(out)){
          out += `mso-ansi-font-size:${pt}pt;`;
        }
        if(!/mso-bidi-font-size:/i.test(out)){
          out += `mso-bidi-font-size:${pt}pt;`;
        }
        return pre + out + post;
      });
    };

    replaceSize("section-title", secPx);
    replaceSize("article-title", titlePx);
    replaceSize("article-body", bodyPx);
    replaceSize("article-link", linkPx);

    return s;
  }catch(e){
    console.warn("applyTypographyToHtmlString failed", e);
    return src;
  }
}

function applyTypographyLive(){
  // Keep exported HTML in sync without rebuilding the whole template (safe while editing).
  if(htmlCode && String(htmlCode).trim()){
    htmlCode = applyTypographyToHtmlString(htmlCode);
  }
  const f = $("previewFrame");
  if(f && f.contentDocument){
    applyTypographyToDoc(f.contentDocument);
  }
  updateLint();
}


// ============================ INLINE VISUAL EDITOR (LIVE PREVIEW) ============================
// Edits happen directly inside the Live Preview iframe (no popup). Apply commits changes to htmlCode.
// The preview is intentionally "locked" while editing to avoid overwriting in-progress edits.

const InlineEditor = {
  enabled: false,
  scope: "content", // "content" | "full"
  sourceOpen: false,
  savedRange: null,
  prevOutlookPreview: false,
  baseHtmlSnapshot: "",
  _uiBound: false,

  _frame(){ return $("previewFrame"); },
  _doc(){ const f=this._frame(); return (f && f.contentDocument) ? f.contentDocument : null; },
  _win(){ const f=this._frame(); return (f && f.contentWindow) ? f.contentWindow : null; },

  _findMain(doc){
    // Prefer the inner white container table (most stable across generated templates)
    return (
      doc.querySelector('table[style*="background-color:#ffffff"][width]') ||
      doc.querySelector('table[style*="background-color:#ffffff"]') ||
      doc.querySelector('table[bgcolor="#ffffff"][width]') ||
      doc.querySelector('table[bgcolor="#ffffff"]') ||
      doc.querySelector('table[width]') ||
      null
    );
  },

  _setState(msg){
    const el = $("ieState");
    if(el) el.textContent = msg;
  },

  showBar(on){
    const bar = $("inlineEditor");
    if(!bar) return;
    bar.setAttribute("aria-hidden", on ? "false" : "true");
  },

  initUI(){
    if(this._uiBound) return;
    const bar = $("inlineEditor");
    if(!bar) return;

    this._uiBound = true;

    // Toolbar buttons
    bar.querySelectorAll("[data-cmd]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(!this.enabled) return;
        this.exec(btn.getAttribute("data-cmd"));
      });
    });

    bar.querySelectorAll("[data-action]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if(!this.enabled) return;
        const act = btn.getAttribute("data-action");
        if(act === "link") return this.actionLink();
        if(act === "image") return this.actionImage();
        if(act === "table") return this.actionTable();
        if(act === "removeformat") return this.actionRemoveFormat();
      });
    });

    const blockSel = $("ieBlockSelect");
    if(blockSel){
      blockSel.addEventListener("change", ()=>{
        if(!this.enabled) return;
        const v = blockSel.value || "P";
        this.exec("formatBlock", "<" + v + ">");
      });
    }

    const scopeSel = $("ieScope");
    if(scopeSel){
      scopeSel.addEventListener("change", ()=>{
        this.scope = scopeSel.value || "content";
        if(this.enabled){
          this.attachToFrame(true);
        }
      });
    }

    const discardBtn = $("ieDiscardBtn");
    if(discardBtn){
      discardBtn.addEventListener("click", ()=>{
        if(!this.enabled) return;
        this.disable(true);
        refreshPreview({force:true});
        toast("Discarded");
      });
    }

    const htmlBtn = $("ieToggleHtmlBtn");
    if(htmlBtn){
      htmlBtn.addEventListener("click", ()=>{
        if(!this.enabled) return;
        this.toggleSource();
      });
    }

    const applyHtmlBtn = $("ieApplyHtmlBtn");
    if(applyHtmlBtn){
      applyHtmlBtn.addEventListener("click", ()=>{
        if(!this.enabled) return;
        this.applySourceToPreview();
      });
    }
  },

  toggle(){
    if(this.enabled){
      this.disable(true);
      refreshPreview({force:true});
      toast("Edit mode off");
      return;
    }
    this.enable();
  },

  enable(){
    if(!htmlCode || !String(htmlCode).trim()){
      toast("Generate a template first", "warning");
      return;
    }

    this.scope = ($("ieScope")?.value || "content");
    this.enabled = true;
    this.savedRange = null;
    this.baseHtmlSnapshot = htmlCode;

    // Turn off Outlook preview while editing (editing transformed HTML is error-prone)
    const out = $("outlookPreviewToggle");
    if(out){
      this.prevOutlookPreview = !!out.checked;
      out.checked = false;
      out.disabled = true;
    }

    this.showBar(true);
    this._setState("Edit mode on. Preview is locked while editing. Use ‚ÄúApply visual changes‚Äù to save.");
    refreshPreview({force:true, raw:true});
  },

  disable(silent){
    this.enabled = false;
    this.savedRange = null;
    this.baseHtmlSnapshot = "";

    // Restore Outlook preview toggle state
    const out = $("outlookPreviewToggle");
    if(out){
      out.disabled = false;
      out.checked = !!this.prevOutlookPreview;
    }

    this.closeSource(true);
    this.showBar(false);
    if(!silent) toast("Edit mode off");
  },

  attachToFrame(resetSelection){
    if(!this.enabled) return;
    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    // Inject lightweight editing CSS (once)
    if(!doc.getElementById("ieInjectedStyle")){
      const st = doc.createElement("style");
      st.id = "ieInjectedStyle";
      st.textContent = `
        body.ie-editing{cursor:text}
        [data-ie-editable="1"]{outline:2px solid rgba(37,99,235,0.22); outline-offset:2px;}
        [data-ie-editable="1"]:focus{outline-color:rgba(37,99,235,0.45)}
        a{cursor:text !important}
      `;
      (doc.head || doc.documentElement).appendChild(st);
    }

    // Clear previous editable markers
    try{
      doc.body.classList.remove("ie-editing");
      doc.body.removeAttribute("contenteditable");
      doc.querySelectorAll('[data-ie-editable="1"]').forEach(el=>{
        el.removeAttribute("contenteditable");
        el.removeAttribute("data-ie-editable");
      });
    }catch(e){}

    // Apply editable scope
    if(this.scope === "full"){
      doc.body.classList.add("ie-editing");
      doc.body.setAttribute("contenteditable","true");
      doc.body.setAttribute("data-ie-editable","1");
    }else{
      const main = this._findMain(doc);
      const target = main || doc.body;
      target.setAttribute("contenteditable","true");
      target.setAttribute("data-ie-editable","1");
      doc.body.classList.add("ie-editing");
    }

    // Bind event listeners once per document
    if(!doc.__ieBound){
      doc.__ieBound = true;

      const saveSel = ()=>{ InlineEditor.saveRange(); };

      doc.addEventListener("mouseup", saveSel, true);
      doc.addEventListener("keyup", saveSel, true);
      doc.addEventListener("touchend", saveSel, true);

      // Prevent navigation while editing
      doc.addEventListener("click", (e)=>{
        if(!InlineEditor.enabled) return;
        const a = e.target && e.target.closest ? e.target.closest("a") : null;
        if(a){
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);

      // Keep source panel in sync if open
      doc.addEventListener("input", ()=>{
        if(InlineEditor.enabled && InlineEditor.sourceOpen){
          InlineEditor._syncSourceFromPreview();
        }
      }, true);
    }

    if(resetSelection){
      this.savedRange = null;
    }

    // Focus frame so formatting commands work smoothly
    try{ win.focus(); }catch(e){}
  },

  saveRange(){
    if(!this.enabled) return;
    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    const sel = win.getSelection && win.getSelection();
    if(!sel || !sel.rangeCount) return;

    const r = sel.getRangeAt(0);
    const editable = doc.querySelector('[data-ie-editable="1"]') || doc.body;
    if(editable && editable.contains(r.commonAncestorContainer)){
      this.savedRange = r.cloneRange();
    }
  },

  restoreRange(){
    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    const sel = win.getSelection && win.getSelection();
    if(!sel) return;

    const editable = doc.querySelector('[data-ie-editable="1"]') || doc.body;

    sel.removeAllRanges();
    if(this.savedRange){
      sel.addRange(this.savedRange);
      return;
    }

    const r = doc.createRange();
    r.selectNodeContents(editable);
    r.collapse(false);
    sel.addRange(r);
    this.savedRange = r.cloneRange();
  },

  exec(cmd, value){
    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    try{ win.focus(); }catch(e){}
    this.restoreRange();

    try{
      doc.execCommand(cmd, false, value);
    }catch(e){
      console.warn("Inline editor command failed:", cmd, e);
    }

    this.saveRange();
    if(this.sourceOpen) this._syncSourceFromPreview();
  },

  _insertHTML(html){
    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    try{ win.focus(); }catch(e){}
    this.restoreRange();

    const sel = win.getSelection && win.getSelection();
    if(!sel || !sel.rangeCount) return;

    const range = sel.getRangeAt(0);
    range.deleteContents();

    const tpl = doc.createElement("template");
    tpl.innerHTML = String(html || "");
    const frag = tpl.content;
    const last = frag.lastChild;

    range.insertNode(frag);

    if(last){
      const r2 = doc.createRange();
      r2.setStartAfter(last);
      r2.collapse(true);
      sel.removeAllRanges();
      sel.addRange(r2);
      this.savedRange = r2.cloneRange();
    }

    this.saveRange();
    if(this.sourceOpen) this._syncSourceFromPreview();
  },

  actionLink(){
    const url = prompt("Link URL", "https://");
    if(!url) return;

    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    try{ win.focus(); }catch(e){}
    this.restoreRange();

    const sel = win.getSelection && win.getSelection();
    const hasSel = sel && sel.rangeCount && !sel.getRangeAt(0).collapsed;

    if(hasSel){
      this.exec("createLink", url);
      return;
    }

    // Collapsed selection: insert a link node
    const safeUrl = String(url);
    const linkHtml = `<a href="${esc(safeUrl)}" style="color:#2563eb;text-decoration:none;">${esc(safeUrl)}</a>`;
    this._insertHTML(linkHtml);
  },

  actionImage(){
    const url = prompt("Image URL", "https://");
    if(!url) return;

    let w = prompt("Image width in px (optional)", "");
    w = (w || "").trim();
    const widthAttr = (w && /^\d+$/.test(w)) ? ` width="${w}"` : "";
    const style = `style="display:block;height:auto;-ms-interpolation-mode:bicubic;max-width:100%;"`;

    this._insertHTML(`<img src="${esc(url)}" alt=""${widthAttr} ${style}>`);
  },

  actionTable(){
    const rStr = prompt("Rows", "2");
    const cStr = prompt("Columns", "2");
    const rows = Math.max(1, Math.min(20, parseInt(rStr,10)||2));
    const cols = Math.max(1, Math.min(10, parseInt(cStr,10)||2));

    let trs = "";
    for(let i=0;i<rows;i++){
      let tds = "";
      for(let j=0;j<cols;j++){
        tds += `<td style="border:1px solid #e5e7eb;padding:8px;vertical-align:top;">&nbsp;</td>`;
      }
      trs += `<tr>${tds}</tr>`;
    }

    const tbl = `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"
      style="border-collapse:collapse;border:1px solid #e5e7eb;">${trs}</table><p style="margin:0 0 10px">&nbsp;</p>`;

    this._insertHTML(tbl);
  },

  actionRemoveFormat(){
    this.exec("removeFormat");
    try{ this.exec("unlink"); }catch(e){}
  },

  toggleSource(){
    const wrap = $("ieSourceWrap");
    if(!wrap) return;

    this.sourceOpen = !this.sourceOpen;
    wrap.setAttribute("aria-hidden", this.sourceOpen ? "false" : "true");

    if(this.sourceOpen){
      this._syncSourceFromPreview();
      this._setState("HTML source mode. Edit and click ‚ÄúUpdate preview‚Äù.");
    }else{
      this._setState("Click inside the preview to edit. Use ‚ÄúApply visual changes‚Äù to save.");
    }
  },

  closeSource(silent){
    const wrap = $("ieSourceWrap");
    if(wrap){
      this.sourceOpen = false;
      wrap.setAttribute("aria-hidden","true");
    }
    if(!silent) this._setState("Click inside the preview to edit. Use ‚ÄúApply visual changes‚Äù to save.");
  },

  _syncSourceFromPreview(){
    const ta = $("ieSourceTextarea");
    if(!ta) return;

    const doc = this._doc();
    if(!doc) return;

    if(this.scope === "full"){
      ta.value = "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
      return;
    }

    const main = this._findMain(doc);
    ta.value = main ? (main.innerHTML || "") : (doc.body.innerHTML || "");
  },

  applySourceToPreview(){
    const ta = $("ieSourceTextarea");
    if(!ta) return;

    const text = String(ta.value || "");
    const doc = this._doc();
    const win = this._win();
    if(!doc || !win) return;

    if(this.scope === "full"){
      // Reload iframe with the provided HTML (keeps edit mode on after load)
      const frame = this._frame();
      frame.srcdoc = text;
      frame.onload = ()=>{
        applyZoom(config.zoom || 1);
        InlineEditor.attachToFrame(true);
      };
      return;
    }

    const main = this._findMain(doc) || doc.body;
    main.innerHTML = text;
    this.attachToFrame(true);
  }
};

function applyInlineEdits(){
  if(typeof InlineEditor === "undefined" || !InlineEditor.enabled){
    toast("Enable Visual edit first", "warning");
    return;
  }

  const frame = $("previewFrame");
  const doc = frame && frame.contentDocument ? frame.contentDocument : null;
  if(!doc){
    toast("Preview not ready", "warning");
    return;
  }

  const scope = (InlineEditor.scope || ($("ieScope")?.value || "content"));

  try{
    let full = "";

    if(scope === "full"){
      full = "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
    }else{
      const editedMain = InlineEditor._findMain(doc);
      const editedInner = editedMain ? (editedMain.innerHTML || "") : (doc.body.innerHTML || "");

      const baseDoc = new DOMParser().parseFromString((InlineEditor.baseHtmlSnapshot || htmlCode) || "<html><body></body></html>", "text/html");
      const baseMain = InlineEditor._findMain(baseDoc) || baseDoc.body;
      baseMain.innerHTML = editedInner;

      full = "<!DOCTYPE html>\n" + baseDoc.documentElement.outerHTML;
    }

    htmlCode = sanitizeEmailHTML(full);
    InlineEditor.disable(true);
    refreshPreview({force:true});
    updateLint();
    toast("Applied", "success");
  }catch(e){
    console.error(e);
    toast("Apply failed", "error");
  }
}

// --- Visual editor: open modal, edit visual or HTML, apply back ---
//
// Free, self-contained WYSIWYG editor built on contenteditable.
// Note: document.execCommand is deprecated but still broadly supported across browsers,
// and is the most compatible option for a single-file, dependency-free tool.

const VE = {
  initDone: false,
  ready: false,
  mode: "wysiwyg", // "wysiwyg" | "code"
  savedRange: null,
  changeTimer: null
};

function visualEditorFindMainContainer(doc){
  // Prefer the inner white container table
  return (
    doc.querySelector('table[style*="background-color:#ffffff"][width]') ||
    doc.querySelector('table[style*="background-color:#ffffff"]') ||
    doc.querySelector('table[bgcolor="#ffffff"][width]') ||
    doc.querySelector('table[bgcolor="#ffffff"]') ||
    doc.querySelector('table[width]') ||
    null
  );
}

function visualEditorSetState(text){
  const el = $("veEditorState");
  if(el) el.textContent = text;
}

function visualEditorSaveRange(){
  const ed = $("veRichEditor");
  if(!ed) return;
  const sel = window.getSelection && window.getSelection();
  if(!sel || !sel.rangeCount) return;
  const r = sel.getRangeAt(0);
  if(ed.contains(r.commonAncestorContainer)){
    VE.savedRange = r.cloneRange();
  }
}

function visualEditorRestoreRange(){
  const ed = $("veRichEditor");
  if(!ed) return;
  const sel = window.getSelection && window.getSelection();
  if(!sel) return;

  if(VE.savedRange){
    sel.removeAllRanges();
    sel.addRange(VE.savedRange);
  }else{
    const r = document.createRange();
    r.selectNodeContents(ed);
    r.collapse(false);
    sel.removeAllRanges();
    sel.addRange(r);
    VE.savedRange = r.cloneRange();
  }
}

function visualEditorInsertHtmlAtCursor(html){
  const ed = $("veRichEditor");
  if(!ed) return;
  ed.focus();
  visualEditorRestoreRange();

  const sel = window.getSelection && window.getSelection();
  if(!sel || !sel.rangeCount) return;

  const range = sel.getRangeAt(0);
  range.deleteContents();

  const tpl = document.createElement("template");
  tpl.innerHTML = String(html || "");
  const frag = tpl.content;

  const last = frag.lastChild;
  range.insertNode(frag);

  if(last){
    const r2 = document.createRange();
    r2.setStartAfter(last);
    r2.collapse(true);
    sel.removeAllRanges();
    sel.addRange(r2);
    VE.savedRange = r2.cloneRange();
  }

  visualEditorQueuePreviewUpdate();
}

function visualEditorExec(cmd, value){
  const rich = $("veRichEditor");
  if(!rich) return;

  rich.focus();
  visualEditorRestoreRange();

  try{
    document.execCommand(cmd, false, value);
  }catch(e){
    console.warn("execCommand failed:", cmd, e);
  }

  visualEditorSaveRange();
  visualEditorQueuePreviewUpdate();
}

function visualEditorActionLink(){
  const rich = $("veRichEditor");
  if(!rich) return;

  const url = prompt("Link URL", "https://");
  if(!url) return;

  rich.focus();
  visualEditorRestoreRange();

  const sel = window.getSelection && window.getSelection();
  if(!sel || !sel.rangeCount){
    visualEditorExec("createLink", url);
    return;
  }

  const r = sel.getRangeAt(0);
  if(r.collapsed){
    const a = document.createElement("a");
    a.href = url;
    a.textContent = url;
    a.style.color = "#2563eb";
    a.style.textDecoration = "none";
    r.insertNode(a);

    r.setStartAfter(a);
    r.collapse(true);
    sel.removeAllRanges();
    sel.addRange(r);
    VE.savedRange = r.cloneRange();

    visualEditorQueuePreviewUpdate();
    return;
  }

  visualEditorExec("createLink", url);
}

function visualEditorActionImage(){
  const url = prompt("Image URL", "https://");
  if(!url) return;

  let w = prompt("Image width in px (optional)", "");
  w = (w || "").trim();
  const widthAttr = (w && /^\d+$/.test(w)) ? ` width="${w}"` : "";
  const style = `style="display:block;height:auto;-ms-interpolation-mode:bicubic;max-width:100%;"`;

  visualEditorInsertHtmlAtCursor(`<img src="${esc(url)}" alt=""${widthAttr} ${style}>`);
}

function visualEditorActionTable(){
  const rStr = prompt("Rows", "2");
  const cStr = prompt("Columns", "2");
  const rows = Math.max(1, Math.min(20, parseInt(rStr,10)||2));
  const cols = Math.max(1, Math.min(10, parseInt(cStr,10)||2));

  let trs = "";
  for(let i=0;i<rows;i++){
    let tds = "";
    for(let j=0;j<cols;j++){
      tds += `<td style="border:1px solid #e5e7eb;padding:8px;vertical-align:top;">&nbsp;</td>`;
    }
    trs += `<tr>${tds}</tr>`;
  }

  const tbl = `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"
    style="border-collapse:collapse;border:1px solid #e5e7eb;">
    ${trs}
  </table><p style="margin:0 0 10px">&nbsp;</p>`;

  visualEditorInsertHtmlAtCursor(tbl);
}

function visualEditorActionRemoveFormat(){
  visualEditorExec("removeFormat");
  try{ document.execCommand("unlink", false, null); }catch(e){}
  visualEditorQueuePreviewUpdate();
}

function visualEditorToggleCode(forceMode){
  const rich = $("veRichEditor");
  const src  = $("veSourceEditor");
  const btn  = $("veCodeToggleBtn");
  if(!rich || !src) return;

  const next = forceMode ? String(forceMode) : (VE.mode === "wysiwyg" ? "code" : "wysiwyg");
  if(next === VE.mode) return;

  if(next === "code"){
    src.value = rich.innerHTML || "";
    src.style.display = "block";
    rich.style.display = "none";
    VE.mode = "code";
    if(btn) btn.classList.add("active");
    visualEditorSetState("HTML source");
    src.focus();
  }else{
    rich.innerHTML = src.value || "";
    rich.style.display = "block";
    src.style.display = "none";
    VE.mode = "wysiwyg";
    if(btn) btn.classList.remove("active");
    visualEditorSetState("Ready");
    rich.focus();
    visualEditorSaveRange();
  }

  visualEditorQueuePreviewUpdate();
}

function visualEditorQueuePreviewUpdate(){
  if(VE.changeTimer) clearTimeout(VE.changeTimer);
  VE.changeTimer = setTimeout(()=>{
    const htmlInner = visualEditorGetContent();
    visualEditorUpdateLivePreview(htmlInner, $("veScope")?.value || "content");
  }, 180);
}

function visualEditorInit(){
  if(VE.initDone) return;
  VE.initDone = true;
  VE.ready = false;
  VE.mode = "wysiwyg";

  const rich = $("veRichEditor");
  const src  = $("veSourceEditor");
  const blockSel = $("veBlockSelect");

  if(!rich || !src){
    visualEditorSetState("Unavailable");
    VE.ready = false;
    return;
  }

  // Prevent toolbar controls from stealing focus/selection
  document.querySelectorAll("#visualModal .ve-toolbar button, #visualModal .ve-toolbar select").forEach(el=>{
    el.addEventListener("mousedown", (e)=>{ e.preventDefault(); });
  });

  if(blockSel){
    blockSel.addEventListener("change", ()=>{
      const v = blockSel.value || "P";
      const tag = v.startsWith("<") ? v : ("<" + v + ">");
      visualEditorExec("formatBlock", tag);
    });
  }

  document.querySelectorAll('#visualModal .ve-tbtn[data-cmd]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const cmd = btn.getAttribute("data-cmd");
      if(cmd) visualEditorExec(cmd);
    });
  });

  document.querySelectorAll('#visualModal .ve-tbtn[data-action]').forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const a = btn.getAttribute("data-action");
      if(a === "link") return visualEditorActionLink();
      if(a === "image") return visualEditorActionImage();
      if(a === "table") return visualEditorActionTable();
      if(a === "removeformat") return visualEditorActionRemoveFormat();
    });
  });

  if($("veCodeToggleBtn")) $("veCodeToggleBtn").addEventListener("click", ()=>visualEditorToggleCode());

  ["keyup","mouseup","touchend","focus"].forEach(ev=>{
    rich.addEventListener(ev, visualEditorSaveRange);
  });

  rich.addEventListener("input", ()=>{ visualEditorSaveRange(); visualEditorQueuePreviewUpdate(); });
  rich.addEventListener("paste", ()=>{ setTimeout(()=>{ visualEditorSaveRange(); visualEditorQueuePreviewUpdate(); }, 0); });
  src.addEventListener("input", visualEditorQueuePreviewUpdate);

  VE.ready = true;
  visualEditorSetState("Ready");
}

function visualEditorSetContent(htmlInner){
  if(!VE.initDone) visualEditorInit();
  const rich = $("veRichEditor");
  const src  = $("veSourceEditor");
  if(!rich || !src) return;

  rich.innerHTML = htmlInner || "";
  src.value = htmlInner || "";

  // Always return to WYSIWYG on load
  visualEditorToggleCode("wysiwyg");
  visualEditorSaveRange();
}

function visualEditorGetContent(){
  const rich = $("veRichEditor");
  const src  = $("veSourceEditor");
  if(VE.mode === "code") return (src ? src.value : "");
  return (rich ? rich.innerHTML : "");
}

function visualEditorExtract(htmlFull, scope){
  const scopeMode = (scope === "full") ? "full" : "content";
  if(scopeMode === "full"){
    return {scope:"full", content: String(htmlFull || "")};
  }
  try{
    const doc = new DOMParser().parseFromString(htmlFull || "<html><body></body></html>", "text/html");
    const main = visualEditorFindMainContainer(doc);
    return {scope:"content", content: main ? (main.innerHTML || "") : ""};
  }catch(e){
    return {scope:"content", content:""};
  }
}

function visualEditorBuildFullHtmlFromEdited(htmlInner, scope){
  const scopeMode = (scope === "full") ? "full" : "content";
  if(scopeMode === "full"){
    return String(htmlInner || "");
  }
  try{
    const doc = new DOMParser().parseFromString(htmlCode || "<html><body></body></html>", "text/html");
    const main = visualEditorFindMainContainer(doc);
    if(main) main.innerHTML = String(htmlInner || "");
    const serialized = "<!DOCTYPE html>\n" + doc.documentElement.outerHTML;
    return serialized;
  }catch(e){
    return String(htmlCode || "");
  }
}

function visualEditorUpdateLivePreview(htmlInner, scope){
  const frame = $("vePreviewFrame");
  if(!frame) return;
  const full = visualEditorBuildFullHtmlFromEdited(htmlInner, scope);
  frame.srcdoc = full;
}

function visualEditorLoadFromHtml(htmlFull, scope){
  visualEditorInit();
  const scopeMode = (scope === "full") ? "full" : "content";
  const extracted = visualEditorExtract(htmlFull, scopeMode);
  visualEditorSetContent(extracted.content || "");
  visualEditorUpdateLivePreview(extracted.content || "", scopeMode);

  const scopeEl = $("veScope");
  if(scopeEl) scopeEl.value = scopeMode;
}

function openVisualEditor(){
  const modal = $("visualModal");
  if(!modal) return;

  // Wire modal buttons once
  if(!$("veApplyBtn")?.dataset?.bound){
    $("veApplyBtn").dataset.bound = "1";
    $("veApplyBtn").addEventListener("click", applyVisualEditor);
    $("veCancelBtn").addEventListener("click", closeVisualEditor);
    $("veCloseBtn").addEventListener("click", closeVisualEditor);

    const scopeEl = $("veScope");
    if(scopeEl){
      scopeEl.addEventListener("change", ()=>{
        visualEditorLoadFromHtml(htmlCode, scopeEl.value || "content");
      });
    }
  }

  modal.setAttribute("aria-hidden","false");
  modal.style.display = "flex";
  document.documentElement.classList.add("modal-open");
  document.body.classList.add("modal-open");

  const scope = ($("veScope")?.value || "content");
  visualEditorLoadFromHtml(htmlCode, scope);
}

function closeVisualEditor(){
  const modal = $("visualModal");
  if(!modal) return;
  modal.setAttribute("aria-hidden","true");
  modal.style.display = "none";
  document.documentElement.classList.remove("modal-open");
  document.body.classList.remove("modal-open");
}

function applyVisualEditor(){
  const scope = ($("veScope")?.value || "content");
  const htmlInner = visualEditorGetContent();

  try{
    const full = visualEditorBuildFullHtmlFromEdited(htmlInner, scope);
    htmlCode = sanitizeEmailHTML(full);
    closeVisualEditor();
    refreshPreview();
    updateLint();
    toast("Applied", "success");
  }catch(e){
    console.error(e);
    toast("Apply failed", "error");
  }
}

function applyVisualBack(){ openVisualEditor(); }

function sanitizeEmailHTML(src){
  let s=String(src);
  s=s.replace(/<script[\s\S]*?<\/script>/gi,"");
  s=s.replace(/<div([^>]*)>/gi,"<p$1>").replace(/<\/div>/gi,"</p>");
  s=s.replace(/(<img\b[^>]*?)style="([^"]*?)width:\s*(\d+)px([^"]*?)"/gi,(m,pre,style,px,post)=>`${pre}style="${style}${post}" width="${px}"`);
  return s;
}
function toast(msg, type = 'default'){
  // Ensure toast container exists
  let container = document.querySelector('.toast-container');
  if(!container){
    container = document.createElement('div');
    container.className = 'toast-container';
    document.body.appendChild(container);
  }

  const n = document.createElement('div');
  n.className = 'toast' + (type !== 'default' ? ' toast-' + type : '');

  // Add icon based on type
  const icons = {
    success: '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>',
    error: '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>',
    warning: '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>',
    default: '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>'
  };

  n.innerHTML = (icons[type] || icons.default) + '<span>' + msg + '</span>';
  container.appendChild(n);

  // Auto-remove with animation
  setTimeout(() => {
    n.classList.add('hiding');
    setTimeout(() => n.remove(), 200);
  }, 2500);
}

// ============================ EXPORT (Outlook safe) ============================
function outlookSafeTransform(src){
  try{
    let s = String(src);
    const base = Math.round(OUTLOOK_BASE_PX * (clampInt(config.containerPct,60,120)) / 100);

    s = s.replace(/<table\b[^>]*>/gi, (tag) => {
      const isWhite = /background-color:\s*#ffffff/i.test(tag) || /\bbgcolor\s*=\s*["']?#ffffff["']?/i.test(tag);
      if(!isWhite) return tag;
      if(!/\bwidth\s*=\s*["']?\d+["']?/i.test(tag)) return tag;
      return tag.replace(/\bwidth\s*=\s*["']?\d+["']?/i, `width="${base}"`);
    });

    s = s.replace(/(<table\b(?![^>]*\bborder=)[^>]*)(>)/gi, '$1 border="0"$2');

    s = s.replace(/(<img\b[^>]*style="[^"]*?)width:\s*(\d+)%([^"]*?")/gi, (m, pre, pct, post) => {
      const p = parseInt(pct, 10) || 100;
      const px = Math.round(base * p / 100);
      return `${pre}width:${px}px${post}`;
    });

    s = s.replace(/<img\b([^>]*?)>/gi, (m, attrs) => {
      if (/\bwidth=/.test(attrs)) return m;
      const styleMatch = /width:\s*(\d+)px/.exec(attrs);
      const w = styleMatch ? styleMatch[1] : base;
      return `<img${attrs} width="${w}">`;
    });

    s = s.replace(/max-width:\s*100%;?/gi, '');
    s = s.replace(/height:\s*auto;?/gi, 'height:auto;-ms-interpolation-mode:bicubic;');
    s = s.replace(/background(?:-image)?:\s*linear-gradient\([^)]*\);?/gi, '');
    s = s.replace(/box-shadow:[^;"]*;?/gi, '');
    s = s.replace(/filter:[^;"]*;?/gi, '');
    return s;
  }catch(e){
    console.error(e);
    return src;
  }
}
function runLinter(src){
  const box = $("lintBox");
  if(!box) return;
  if(!src || !String(src).trim()){
    box.textContent = "Generate a feed to see export warnings.";
    return;
  }
  const out = [];
  if(/<div\b/i.test(src)) out.push("Note: <div> tags will be converted to <p> during sanitization; prefer tables for best email compatibility.");
  if(/<img(?![^>]*\bwidth=)/i.test(src)) out.push("Some <img> lack width attributes.");
  if(/<img\b(?![^>]*\balt=)[^>]*>/i.test(src)) out.push("Some <img> lack alt text.");
  box.innerHTML = out.length ? ("Warnings: " + out.join(" ¬∑ ")) : "No export warnings.";
}
function updateLint(){
  const src = ($("outlookSafeToggle")?.checked) ? outlookSafeTransform(htmlCode) : htmlCode;
  runLinter(src || "");
}

function minify(s){ return String(s).replace(/\n+/g," ").replace(/>\s+</g,"><").replace(/\s{2,}/g," "); }

// ============================ BUILD ============================
function getFiltered(){
  const days = Math.max(0, parseInt(config.daysBack,10)||0);
  const limit = Math.max(0, parseInt(config.limitItems,10)||0);
  const since = days>0 ? Date.now()-days*86400000 : 0;

  let list = allArticles.filter(a=>{
    if(!a || !a.include) return false;
    if(!since) return true;
    return (a.pubDate && a.pubDate.getTime && a.pubDate.getTime()>=since);
  });

  list.sort((a,b)=>{
    const as=(a.sortIndexCat!=null), bs=(b.sortIndexCat!=null);
    if(as&&bs) return a.sortIndexCat-b.sortIndexCat;
    if(as&&!bs) return -1;
    if(!as&&bs) return 1;
    return 0;
  });

  if(limit>0) list = list.slice(0,limit);
  return list;
}

function computeOrder(grouped){
  const tags = Object.keys(grouped);
  return (config.sectionOrder && config.sectionOrder.length)
    ? config.sectionOrder.filter(t=>tags.includes(t)).concat(tags.filter(t=>!config.sectionOrder.includes(t)))
    : tags.sort((a,b)=>a.localeCompare(b));
}

function autoColorForTag(tag){
  const raw = (tag || "Other").toString();
  const lower = raw.toLowerCase();

  // Keep "Other" neutral by default
  if(lower==="other") return "#f8fafc";

  // Use a deterministic, stable hash so colors remain consistent across sessions
  let h = 0;
  for(let i=0;i<lower.length;i++){ h = ((h * 31) + lower.charCodeAt(i)) >>> 0; }

  const pool = (Array.isArray(PASTEL) ? PASTEL : [])
    .filter(c => c && c.hex)
    .filter(c => !["#ffffff","#f8fafc","#f3f4f6","#fafaf9"].includes((c.hex||"").toLowerCase()));

  if(!pool.length) return "#ffffff";
  return pool[h % pool.length].hex;
}

function colorFor(tag){
  const ov = (config.tagOverrides && config.tagOverrides[tag]) ? config.tagOverrides[tag] : {};
  return ov.color || autoColorForTag(tag);
}
function emojiFor(tag){ const ov=config.tagOverrides[tag]||{}; return ov.emoji||""; }

function buildCard(a, tag){
  const base = parseInt(config.baseFontPx, 10) || 14;
  const lh = parseFloat(config.lineHeight) || 1.5;
  const theme = (config.theme || "cards");
  const pres = (config.articlePresentation || "editorial");

  const fontStack = getFontStack();
  const msoFont = msoFontFamilyCSS();

  const linkColor = (config.linkStyle==="blue") ? "#2563eb"
    : (config.linkStyle==="accent") ? "#1e40af"
    : "#374151";

  const text = "#111827";
  const muted = "#475569";
  const border = "#e5e7eb";
  const dividerColor = "#000000";
  const sectionBg = colorFor(tag || "Other");

  const bodyPx = base;

  // Article typography (explicit sizes for Outlook consistency)
  const titlePx = Math.max(10, Math.min(18, parseInt(config.articleTitlePx, 10) || 12));
  const textPx  = Math.max(9,  Math.min(16, parseInt(config.articleBodyPx, 10) || 10));
  const linkPx  = Math.max(9,  Math.min(16, parseInt(config.linkFontPx, 10) || textPx));
  const metaPx  = Math.max(9,  Math.min(12, textPx - 1));
  const summaryPx = textPx;
  const w = parseInt(config.featuredImageWidthPx, 10) || 260;

  const rad = (config.imageShape==="rounded") ? (String(config.imageRadiusPx||10) + "px")
            : (config.imageShape==="circle") ? "9999px"
            : "0";

  const imgStyle = `border-radius:${rad};display:block;height:auto;-ms-interpolation-mode:bicubic;`;

  const summary = truncateWords(a.preview || "", config.summaryWords);
  const commentRaw = (a.comment || "");
  const comment = (pres==="compact" && (config.commentDisplay||"auto")==="auto") ? "" : commentRaw;

  const showComment = (config.commentDisplay==="show") ? !!commentRaw
                    : (config.commentDisplay==="hide") ? false
                    : !!comment; // auto

  const commentStyle = (config.commentStyle || "callout");

  const titleHTML = `<p data-nl="article-title" style="margin:0 0 6px;color:${text};font-family:${fontStack};${msoFont}font-size:${titlePx}px;${msoFontSizeCSSExact(titlePx)}line-height:1.3;font-weight:600;letter-spacing:0;mso-line-height-rule:exactly;">${esc(a.title||"(no title)")}</p>`;
  const domain = (a.link||"").replace(/^https?:\/\//i,"").replace(/^www\./i,"").split("/")[0].trim();
  const metaHTML = (domain && pres!=="compact")
    ? `<p style="margin:0 0 10px;color:#64748b;font-family:${fontStack};${msoFont}font-size:${metaPx}px;${msoFontSizeCSS(metaPx)}line-height:1.2;mso-line-height-rule:exactly;">${esc(domain)}</p>`
    : "";

  const descHTML = summary
    ? `<p data-nl="article-body" style="margin:0 0 10px;color:${muted};font-family:${fontStack};${msoFont}font-size:${summaryPx}px;${msoFontSizeCSSExact(summaryPx)}line-height:${lh};mso-line-height-rule:exactly;">${esc(summary)}</p>`
    : "";

  const commentHTML = (showComment && commentRaw)
    ? renderCommentBlock(commentRaw, tag, textPx, lh, commentStyle)
    : "";

  const linkHTML = a.link
    ? `<p style="margin:10px 0 0;mso-line-height-rule:exactly;">
         <a data-nl="article-link" href="${esc(a.link)}" style="color:${linkColor};text-decoration:none;font-family:${fontStack};${msoFont}font-size:${linkPx}px;${msoFontSizeCSSExact(linkPx)}line-height:${lh};font-weight:700;mso-line-height-rule:exactly;">Read more ‚Üí</a>
       </p>`
    : "";

  const isCards = (theme==="cards");
  const isStripe = (theme==="stripe");
  const isClean = (theme==="clean" || theme==="divider");


  // Theme styling (Outlook-safe).
  // Clean theme must be truly "no boxes": no border, no radius, and background matches the section.
  const cardBg = (isCards || isStripe) ? "#ffffff" : (isClean ? sectionBg : "transparent");
  // Remove the border around cards entirely.  A border on the table would
  // introduce visible seams between the section header and the first article when
  // imported into Outlook.  Rely on padding and background color to distinguish
  // cards instead of a 1px border.
  const cardBorder = "0";
  const cardRadius = (isCards || isStripe) ? "14px" : "0";
  const padStd = isCards ? "14px 16px" : (isClean ? "6px 0" : "8px 0 8px 0");
  const padCompact = isCards ? "12px 14px" : (isClean ? "4px 0" : "6px 0 6px 0");
  const pad = (pres==="compact") ? padCompact : padStd;
  const tableBgAttr = (cardBg && cardBg !== "transparent") ? ` bgcolor="${cardBg}"` : "";
  const featImgPad = isCards ? "14px 0 14px 14px" : (isClean ? "0 16px 0 0" : "10px 12px 8px 0");
  const featBodyPad = isCards ? "14px 16px 14px 14px" : (isClean ? "0" : "10px 0 8px 0");

  const stripeColor = borderFor(colorFor(tag || "Other"));
  // Suppress the top border for article cards to avoid a visible seam
  // immediately beneath the section header.  Cards retain side and bottom
  // borders for definition, but the top edge is unframed.  This helps ensure
  // there is no dividing line between the section heading and the first
  // article in Outlook and other clients.
  const outerStyle = `border-collapse:collapse;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;background-color:${cardBg};border:${cardBorder};border-top:0;border-radius:${cardRadius};`;

  const bodyHTML = `${titleHTML}${metaHTML}${descHTML}${commentHTML}${linkHTML}`;

  if(a.featured){
    const imgHTML = (a.image)
      ? `<img src="${esc(a.image)}" alt="" style="${imgStyle}" width="${w}">`
      : "";

    if(isStripe){
      return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"${tableBgAttr} style="${outerStyle}">
        <tr>
          <td width="6" bgcolor="${stripeColor}" style="background-color:${stripeColor};font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td>
          <td width="${w}" valign="top" style="padding:14px 0 14px 12px;">
            ${imgHTML}
          </td>
          <td valign="top" style="padding:14px 16px 14px 14px;">
            ${bodyHTML}
          </td>
        </tr>
      </table>`;
    }

    return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"${tableBgAttr} style="${outerStyle}">
      <tr>
        <td width="${w}" valign="top" style="padding:${featImgPad};background-color:${cardBg};">
          ${imgHTML}
        </td>
        <td valign="top" style="padding:${featBodyPad};background-color:${cardBg};">
          ${bodyHTML}
        </td>
      </tr>
    </table>`;
  }

  if(isStripe){
    return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"${tableBgAttr} style="${outerStyle}">
      <tr>
        <td width="6" bgcolor="${stripeColor}" style="background-color:${stripeColor};font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td>
        <td style="padding:${(pres==="compact") ? "10px 12px" : (isCards ? "14px 16px" : "10px 0 8px 12px")};">
          ${bodyHTML}
        </td>
      </tr>
    </table>`;
  }

  return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"${tableBgAttr} style="${outerStyle}">
    <tr>
      <td style="padding:${pad};background-color:${cardBg};">
        ${bodyHTML}
      </td>
    </tr>
  </table>`;
}

function renderCommentBlock(commentText, tag, basePx, lineHeight, style){
  const raw = String(commentText || "").trim();
  if(!raw) return "";

  const stripeColor = borderFor(colorFor(tag || "Other"));
  const muted = "#64748b";
  const ink = "#0f172a";
  const border = "#e5e7eb";
  const dividerColor = "#000000";
  const sectionBg = colorFor(tag || "Other");
  const soft = "#f8fafc";
  const labelPx = Math.max(9, Math.min(12, basePx - 1));

  const fontStack = getFontStack();
  const msoFont = msoFontFamilyCSS();

  // Compact mode: keep comments short so layout stays tight in multi-column views.
  const txt = truncateWords(raw, (config.articlePresentation==="compact" ? 26 : 0));
  if(!txt) return "";

  const cleanLabelPrefix = (s)=>String(s||"").replace(/^(comment|note|takeaway|takeaways|why it matters|editor[‚Äô']?s note)\s*:\s*/i,"").trim();

  function extractPoints(s){
    let v = String(s||"");
    v = v.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
    // Convert common bullet styles to newlines
    v = v.replace(/[‚Ä¢‚ñ™‚óè‚ó¶]/g,"\n");
    v = v.replace(/^\s*[-‚Äì‚Äî]\s+/gm,"\n");
    // Split lines
    let parts = v.split("\n").map(x=>cleanLabelPrefix(x.trim())).filter(Boolean);

    // If we did not get real bullets, fall back to sentences.
    if(parts.length <= 1){
      parts = String(s||"")
        .split(/[.!?]\s+/)
        .map(x=>cleanLabelPrefix(x.trim()))
        .filter(Boolean);
    }

    // Prefer shorter points
    parts = parts
      .map(p=>p.replace(/\s+/g," ").trim())
      .filter(Boolean)
      .slice(0,3)
      .map(p=>truncateWords(p, 18));

    return parts.filter(Boolean);
  }

  if(style === "italic"){
    return `<p data-nl="article-body" style="margin:0 0 10px;color:${muted};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};font-style:italic;mso-line-height-rule:exactly;">${esc(cleanLabelPrefix(txt))}</p>`;
  }

  if(style === "plain"){
    return `<p data-nl="article-body" style="margin:0 0 10px;color:${muted};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};mso-line-height-rule:exactly;">${esc(cleanLabelPrefix(txt))}</p>`;
  }

  if(style === "sidenote"){
    // Minimal, inline ‚Äúnote‚Äù style with a subtle accent mark.
    return `<p data-nl="article-body" style="margin:0 0 10px;color:${muted};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};mso-line-height-rule:exactly;">
      <span style="color:${stripeColor};font-weight:900;margin-right:6px;">|</span>${esc(cleanLabelPrefix(txt))}
    </p>`;
  }

  if(style === "quote"){
    // Pull-quote: italic with left accent and soft background (email-safe table).
    return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;margin:0 0 10px;">
      <tr>
        <td width="4" bgcolor="${stripeColor}" style="background-color:${stripeColor};font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td>
        <td bgcolor="${soft}" style="background-color:${soft};padding:10px 12px;border:1px solid ${border};border-left:0;">
          <p data-nl="article-body" style="margin:0;color:${ink};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};font-style:italic;mso-line-height-rule:exactly;">${esc(cleanLabelPrefix(txt))}</p>
        </td>
      </tr>
    </table>`;
  }

  if(style === "takeaways"){
    const pts = extractPoints(raw);
    if(!pts.length) return "";

    const rows = pts.map(p=>(
      `<tr>
        <td data-nl="article-body" width="14" valign="top" style="color:${stripeColor};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};font-weight:900;mso-line-height-rule:exactly;">‚Ä¢</td>
        <td data-nl="article-body" valign="top" style="color:${ink};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};mso-line-height-rule:exactly;">${esc(p)}</td>
      </tr>`
    )).join("");

    return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;margin:0 0 10px;">
      <tr>
        <td width="4" bgcolor="${stripeColor}" style="background-color:${stripeColor};font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td>
        <td style="padding:10px 12px;border:1px solid ${border};border-left:0;background-color:#ffffff;">
          <p style="margin:0 0 8px;color:${muted};font-size:${labelPx}px;${msoFontSizeCSSExact(labelPx)}line-height:1.2;letter-spacing:0.10em;text-transform:uppercase;font-weight:800;mso-line-height-rule:exactly;">Key points</p>
          <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt;">
            ${rows}
          </table>
        </td>
      </tr>
    </table>`;
  }

  // default: callout (elegant ‚Äúeditor‚Äôs note‚Äù with accent bar)
  return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;margin:0 0 10px;">
    <tr>
      <td width="4" bgcolor="${stripeColor}" style="background-color:${stripeColor};font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td>
      <td bgcolor="${soft}" style="background-color:${soft};padding:10px 12px;border:1px solid ${border};border-left:0;">
        <p style="margin:0 0 6px;color:${muted};font-size:${labelPx}px;${msoFontSizeCSSExact(labelPx)}line-height:1.2;letter-spacing:0.10em;text-transform:uppercase;font-weight:800;mso-line-height-rule:exactly;">Editor‚Äôs note</p>
        <p data-nl="article-body" style="margin:0;color:${ink};font-family:${fontStack};${msoFont}font-size:${basePx}px;${msoFontSizeCSSExact(basePx)}line-height:${lineHeight};mso-line-height-rule:exactly;">${esc(cleanLabelPrefix(txt))}</p>
      </td>
    </tr>
  </table>`;
}




// Exact pixel inner width used by column builder (prevents uneven columns in Outlook)
function innerContentWidthPx(){
  const pct = clampInt(config.containerPct,60,120);
  const outer = Math.round(OUTLOOK_BASE_PX * pct / 100);
  const sectionPadX = 24 * 2; // matches buildSections() padding
  return Math.max(260, outer - sectionPadX);
}

function buildColumns(cards, sectionBg){
  const colsSetting = parseInt(config.columns, 10) || 1;
  const maxCols = Math.max(1, Math.min(3, colsSetting));
  if (!cards || cards.length === 0) return "";

  const theme = (config.theme || "cards");
  const isDivider = false; // Dividers are disabled (spacing only)
  const itemGap = (theme === "cards") ? 14 : ((theme === "divider") ? 14 : 12);

  const base = parseInt(config.baseFontPx, 10) || 15;
  const lh = Math.max(1.1, Math.min(2.0, parseFloat(config.lineHeight) || 1.45));
  const secTitlePx = Math.max(18, Math.min(22, base + 5));

  const bg = sectionBg || "#ffffff";
  const innerW = innerContentWidthPx();

  const dividerRow = `<tr><td bgcolor="${bg}" style="background-color:${bg};padding:0;">
      <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="${bg}"
        style="background-color:${bg};border-collapse:collapse;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;font-family:${getFontStack()};${msoFontFamilyCSS()}font-size:${base}px;${msoFontSizeCSS(base)}line-height:${lh};">
        <tr><td height="1" bgcolor="#000000" style="background-color:#000000;font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td></tr>
      </table>
    </td></tr>`;

  const stackTable = (arr, widthPx, addBottomGap)=> {
    const rows = arr.map((c, idx)=>{
      const isLast = (idx === arr.length - 1);
      const pad = isLast ? (addBottomGap ? itemGap : 0) : itemGap;
      const row = `<tr><td bgcolor="${bg}" style="background-color:${bg};padding:0 0 ${pad}px 0;vertical-align:top;mso-padding-alt:0;">
          ${c}
        </td></tr>`;
      const div = (isDivider && !isLast) ? dividerRow : "";
      return row + div;
    }).join("");

    const wAttr = widthPx ? ` width="${widthPx}"` : ` width="100%"`;
    const wStyle = widthPx ? `width:${widthPx}px;` : `width:100%;`;

    return `<table role="presentation"${wAttr} cellpadding="0" cellspacing="0" border="0" bgcolor="${bg}"
        style="background-color:${bg};${wStyle}border-collapse:separate;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;">
        ${rows}
      </table>`;
  };

  if (maxCols <= 1 || cards.length === 1){
    return stackTable(cards, innerW, false);
  }

  const cols = Math.min(maxCols, cards.length);
  const gutter = (cols === 3) ? 18 : 24;

  const totalGutters = gutter * (cols - 1);
  const usable = Math.max(120, innerW - totalGutters);

  const baseW = Math.floor(usable / cols);
  const widths = Array(cols).fill(baseW);
  widths[cols - 1] = usable - baseW * (cols - 1);

  const buckets = Array.from({length: cols}, ()=>[]);
  cards.forEach((c, i)=>{ buckets[i % cols].push(c); });

  const cells = buckets.map((b, i)=>{
    const colW = widths[i];
    const colTable = stackTable(b, colW, false);

    const cell = `<td width="${colW}" valign="top" bgcolor="${bg}"
        style="padding:0;vertical-align:top;mso-padding-alt:0;background-color:${bg};">
        ${colTable}
      </td>`;

    const gap = (i < cols - 1)
      ? `<td width="${gutter}" bgcolor="${bg}" style="font-size:0;line-height:0;mso-line-height-rule:exactly;background-color:${bg};">&nbsp;</td>`
      : "";

    return cell + gap;
  }).join("");

  return `<table role="presentation" width="${innerW}" bgcolor="${bg}" cellpadding="0" cellspacing="0" border="0"
      style="background-color:${bg};width:${innerW}px;border-collapse:separate;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;">
      <tr>${cells}</tr>
    </table>`;
}

// ---- ToC builder ----
function badgeWidthEstimate(txt){
  const w = Math.round((txt.length * 8) + 28);
  return Math.max(72, Math.min(320, w));
}
function idealTextColor(bg){
  try{ const c=String(bg||"#111827").replace('#',''); const r=parseInt(c.substr(0,2),16), g=parseInt(c.substr(2,2),16), b=parseInt(c.substr(4,2),16);
    const l=(0.299*r+0.587*g+0.114*b)/255; return l<0.6 ? "#ffffff" : "#111827"; }catch(e){ return "#111827"; }
}
function badgeHTML(label, href, bg, border, linked){
  const txt = esc(label);
  const textColor = idealTextColor(bg);
  const inner = linked
    ? `<a href="${href}" style="display:block;color:${textColor};text-decoration:none;">${txt}</a>`
    : `${txt}`;

  return `<table role="presentation" cellpadding="0" cellspacing="0" border="0" style="display:inline-table;border-collapse:separate;mso-table-lspace:0pt;mso-table-rspace:0pt;">
    <tr>
      <td bgcolor="${bg}" style="background-color:${bg};border:1px solid ${border};border-radius:9999px;padding:6px 10px;color:${textColor};font-size:12px;line-height:14px;white-space:nowrap;font-family:${getFontStack()};${msoFontFamilyCSS()}mso-line-height-rule:exactly;">
        ${inner}
      </td>
    </tr>
  </table>`;
}

function buildToc(list){
  if(!config.includeToc) return "";
  const grouped={}; list.forEach(a=>{ const c=a.category||"Other"; (grouped[c]||(grouped[c]=[])).push(a); });
  const order = computeOrder(grouped).filter(k=>grouped[k]&&grouped[k].length);
  if(!order.length) return "";

  const linked = (config.tocStyle==="linked");

  // Outlook (Word engine) often stacks inline-table badges vertically.
  // Use an Outlook-specific single-line text list to ensure horizontal rendering on export/import.
  const msoItems = order.map((cat)=>{
    const slug=slugify(cat); const txt=esc(cat);
    return linked
      ? `<a href="#sec-${slug}" style="color:#1e40af;text-decoration:none;font-weight:700;mso-line-height-rule:exactly;">${txt}</a>`
      : `<span style="color:#111827;font-weight:700;mso-line-height-rule:exactly;">${txt}</span>`;
  });
  const msoLine = `<p style="margin:0;font-size:13px;line-height:1.6;mso-line-height-rule:exactly;">
    ${msoItems.join(`&nbsp;&nbsp;|&nbsp;&nbsp;`)}
  </p>`;

  const inlineSpacer = (w)=>(
    `<table role="presentation" cellpadding="0" cellspacing="0" border="0" style="display:inline-table;vertical-align:middle;border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt;">
      <tr><td width="${w}" style="font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td></tr>
    </table>`
  );

  let nonMso = "";

  if(config.tocPreset==="badges" || config.tocPreset==="two-col"){
    const items = order.map((cat)=>{
      const bg=colorFor(cat); const border=borderFor(bg); const slug=slugify(cat);
      return badgeHTML(cat, `#sec-${slug}`, bg, border, linked);
    });
    nonMso = `<p style="margin:0;font-size:12px;line-height:1.6;mso-line-height-rule:exactly;">
      ${items.map((x,i)=> (i? inlineSpacer(8) : "") + x).join("")}
    </p>`;
  } else if(config.tocPreset==="numbered"){
    const items = order.map((cat, i)=>{
      const slug=slugify(cat); const txt=`${i+1}. ${cat}`;
      return linked
        ? `<a href="#sec-${slug}" style="color:#2563eb;text-decoration:none;font-weight:600;">${esc(txt)}</a>`
        : `<span style="color:#111827;font-weight:600;">${esc(txt)}</span>`;
    });
    nonMso = `<p style="margin:0;font-size:13px;line-height:1.6;mso-line-height-rule:exactly;">
      ${items.join(`&nbsp;&nbsp;¬∑&nbsp;&nbsp;`)}
    </p>`;
  } else {
    const items = order.map((cat)=>{
      const slug=slugify(cat); const txt=esc(cat);
      return linked
        ? `<a href="#sec-${slug}" style="color:#2563eb;text-decoration:none;font-weight:600;">${txt}</a>`
        : `<span style="color:#111827;font-weight:600;">${txt}</span>`;
    });
    nonMso = `<p style="margin:0;font-size:13px;line-height:1.6;mso-line-height-rule:exactly;">
      ${items.join(`&nbsp;&nbsp;¬∑&nbsp;&nbsp;`)}
    </p>`;
  }

  const inner = `<!--[if mso]>${msoLine}<![endif]--><!--[if !mso]><!-- -->${nonMso}<!--<![endif]-->`;

  const theme = (config.theme || "cards");
  const tocBorder = ""; // No ToC dividers (Outlook parity with preview)

  return `<tr><td style="background-color:#ffffff;padding:18px 32px 16px;border-bottom:1px solid #f1f5f9;${tocBorder}">
    <p style="margin:0 0 10px;font-size:14px;line-height:1.2;color:#0f172a;font-weight:800;mso-line-height-rule:exactly;">Sections</p>
    ${inner}
  </td></tr>`;
}


function buildHeader(){
  const bg = config.headerColor || "#ffffff";
  const fg = idealTextColor(bg);
  const muted = (fg==="#ffffff") ? "#cbd5e1" : "#64748b";

  const today = formatToday(config.dateFormat);
  const issueRaw = (config.issueNumber || "").trim();
  const issue = issueRaw ? ("No. " + esc(issueRaw)) : "";

  const title = esc((config.headerText || "Newsletter").replace("{NEWSLETTER_DATE}", today));
  const introRaw = (config.headerSub || "").replace("{NEWSLETTER_DATE}", today);
  const intro = esc(introRaw).replace(/\r\n|\r|\n/g, "<br>");
  const introHtml = (introRaw.trim().length ? intro : "");

  return `<tr><td style="background:${bg};padding:32px 32px 24px;text-align:left;font-family:${getFontStack()};${msoFontFamilyCSS()}">
    <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse;mso-table-lspace:0pt;mso-table-rspace:0pt;">
      <tr>
        <td valign="top" style="padding:0;">
          <p style="margin:0;color:${fg};font-family:${getFontStack()};${msoFontFamilyCSS()}font-size:34px;line-height:1.15;font-weight:800;letter-spacing:-0.5px;mso-line-height-rule:exactly;">${title}</p>
        </td>
        ${issue ? `<td valign="top" align="right" style="padding:0;white-space:nowrap;">
          <p style="margin:0;color:${muted};font-size:12px;line-height:1.3;letter-spacing:0.05em;text-transform:uppercase;font-weight:700;mso-line-height-rule:exactly;">${issue}</p>
        </td>` : ''}
      </tr>
    </table>
    ${introHtml ? `<p style="margin:18px 0 0;color:${muted};font-family:${getFontStack()};${msoFontFamilyCSS()}font-size:15px;line-height:1.65;mso-line-height-rule:exactly;">${introHtml}</p>` : ''}
  </td></tr>`;
}


function formatToday(fmt){
  try{ const d=new Date();
    if(fmt==="MMMM d, yyyy") return d.toLocaleDateString(undefined,{year:"numeric",month:"long",day:"numeric"});
    if(fmt==="yyyy-MM-dd") return d.toISOString().slice(0,10);
    return d.toLocaleDateString();
  }catch(e){ return new Date().toLocaleDateString(); }
}

function outerHTML(sectionsHTML){
  const pct=config.containerPct; const width=Math.round(OUTLOOK_BASE_PX*pct/100);
  const base = parseInt(config.baseFontPx, 10) || 14;
  const lh = parseFloat(config.lineHeight) || 1.5;

  return `<!DOCTYPE html><html><head><meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light">
  <!--[if mso]><xml><o:OfficeDocumentSettings><o:AllowPNG/><o:PixelsPerInch>96</o:PixelsPerInch></o:OfficeDocumentSettings></xml><![endif]-->
  </head><body style="margin:0;padding:0;background-color:#f8fafc;font-size:${base}px;${msoFontSizeCSS(base)}line-height:${lh};color:#0f172a;font-family:${getFontStack()};${msoFontFamilyCSS()}-webkit-text-size-adjust:100%;-ms-text-size-adjust:100%;">
  <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color:#f8fafc">
    <tr><td align="center" style="padding:24px 16px">
      <table role="presentation" width="${width}" cellpadding="0" cellspacing="0" border="0"
        style="background-color:#ffffff;border:1px solid #e2e8f0;border-radius:12px;border-collapse:separate;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;font-family:${getFontStack()};${msoFontFamilyCSS()}font-size:${base}px;${msoFontSizeCSS(base)}line-height:${lh};overflow:hidden;box-shadow:0 4px 6px -1px rgba(0,0,0,0.05),0 2px 4px -2px rgba(0,0,0,0.05);">
        ${buildHeader()}
        ${config.includeToc ? buildToc(getFiltered()) : ""}
        ${sectionsHTML}
      </table>
    </td></tr>
  </table>
  </body></html>`;
}

function buildSections(list){
  const grouped={}; list.forEach(a=>{ const c=a.category||"Other"; (grouped[c]||(grouped[c]=[])).push(a); });
  discoveredTags = Object.keys(grouped).sort((a,b)=>a.localeCompare(b));

  const theme = (config.theme || "cards");
  const isDivider = false; // Dividers are disabled (spacing only)
  const itemGap = (theme === "cards") ? 14 : ((theme === "divider") ? 14 : 12);

  const base = parseInt(config.baseFontPx, 10) || 15;
  const secTitlePx = Math.max(18, Math.min(22, base + 5));
  const gapRow = "";

  const order=computeOrder(grouped);
  const parts=order.map((cat, idx)=>{
    let items=grouped[cat]; if(!items||!items.length) return "";
    const bg=colorFor(cat), border=borderFor(bg), em=emojiFor(cat), slug=slugify(cat);

    const emojiPrefix = em ? (esc(em) + " ") : "";
    const ink = "#0f172a"; // section title text color (Outlook-safe)


    // Simplified section header layout: use a single cell with a left border to draw
    // the colored accent bar.  This avoids the two-cell structure which Outlook may
    // render inconsistently, producing stray horizontal lines.  The border-left
    // property creates the vertical accent, and padding controls spacing below
    // the heading.
    // Section header: draw a single coloured bar on the left that spans exactly the
    // height of the heading text.  We wrap the heading in a nested table where the
    // left border is applied on a cell containing the text.  An additional row
    // provides vertical spacing below the heading without extending the bar.  This
    // structure renders consistently in Outlook and other email clients.
    const headerLine = `
    <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="${bg}"
           style="border-collapse:separate;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;background-color:${bg};">
      <tr>
        <td bgcolor="${bg}" style="background-color:${bg};padding:0;">
          <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0"
                 style="border-collapse:separate;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;">
            <tr>
              <td style="border-left:4px solid ${border};padding-left:12px;">
                <h2 data-nl="section-title"
                    style="margin:0;font-size:${secTitlePx}px;line-height:1.3;font-weight:800;color:${ink};font-family:${getFontStack()};">
                  ${emojiPrefix}${esc(cat)}
                </h2>
              </td>
            </tr>
          </table>
        </td>
      </tr>
      <tr>
        <td height="20" bgcolor="${bg}" style="height:20px;line-height:20px;font-size:0;mso-line-height-rule:exactly;background-color:${bg};">&nbsp;</td>
      </tr>
    </table>
  `;


    // Spacer table removed; we will instead use extra bottom padding on the header cell.  Leaving this definition empty for backward compatibility.
    const afterHeaderSpacer = ``;

    // Stack cards in a single table with padding-based spacing to avoid Outlook "seam" divider artifacts.
    const dividerRow = `<tr><td bgcolor="${bg}" style="background-color:${bg};padding:0;">
        <table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="${bg}"
          style="background-color:${bg};border-collapse:collapse;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;">
          <tr><td height="1" bgcolor="#000000" style="background-color:#000000;font-size:0;line-height:0;mso-line-height-rule:exactly;">&nbsp;</td></tr>
        </table>
      </td></tr>`;

    const stackCards = (arr, addBottomGap)=>{
      if(!arr || arr.length===0) return "";
      const rows = arr.map((c, i)=>{
        const isLast = (i === arr.length-1);
        const pad = isLast ? (addBottomGap ? itemGap : 0) : itemGap;
        const row = `<tr><td bgcolor="${bg}" style="background-color:${bg};padding:0 0 ${pad}px 0;vertical-align:top;mso-padding-alt:0;">
            ${c}
          </td></tr>`;
        const div = (isDivider && !isLast) ? dividerRow : "";
        return row + div;
      }).join("");
      return `<table role="presentation" width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="${bg}"
          style="background-color:${bg};border-collapse:separate;border-spacing:0;mso-table-lspace:0pt;mso-table-rspace:0pt;">
          ${rows}
        </table>`;
    };

    const featuredCards = items.filter(a=>a.featured).map(a=>buildCard(a,cat));
    const nonFeaturedCards = items.filter(a=>!a.featured).map(a=>buildCard(a,cat));

    const featuredHTML = featuredCards.length ? stackCards(featuredCards, nonFeaturedCards.length>0) : "";
    const nonFeaturedHTML = buildColumns(nonFeaturedCards, bg);

    return `${(idx>0) ? gapRow : ""}<tr><td bgcolor="${bg}" style="background-color:${bg};padding:24px 24px 18px;font-family:${getFontStack()};${msoFontFamilyCSS()}">
      <a name="sec-${slug}"></a>
      ${headerLine}
      ${featuredHTML}${nonFeaturedHTML}
    </td></tr>`;
  });
  return parts.join("");
}

function buildHTML(){
  const list = getFiltered();
  const sections = buildSections(list);
  htmlCode = outerHTML(sections);
  refreshPreview();
  populateSectionsBoard();
  updateLint();
}

const queueBuild = debounce(buildHTML, 200);

// ============================ RSS CORE ============================
function looksLikeFeedXML(text){ return /<(rss|feed|rdf:RDF)\b/i.test(text||""); }
async function fetchFeedText(url){
  const timeoutMs = 15000;

  async function fetchText(u){
    const controller = new AbortController();
    const id = setTimeout(()=>controller.abort(), timeoutMs);
    try{
      const res = await fetch(u, {
        signal: controller.signal,
        cache: "no-store",
        headers: { Accept: "application/rss+xml, application/xml, text/xml, */*;q=0.1" }
      });
      if(!res.ok) throw new Error("HTTP " + res.status);
      return await res.text();
    } finally {
      clearTimeout(id);
    }
  }

  const direct = url;
  const allOriginsRaw = "https://api.allorigins.win/raw?url=" + encodeURIComponent(url);
  const allOriginsGet = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);

  // Try fetching directly first
  try {
    const t = await fetchText(direct);
    if (looksLikeFeedXML(t)) {
      return { text: t, via: 'direct' };
    }
  } catch (e) {
    // ignore and fall through to proxies
  }

  // Define proxy endpoints (excluding direct)
  const proxies = [
    {url: allOriginsRaw, label: 'allorigins(raw)'},
    {url: "https://thingproxy.freeboard.io/fetch/" + url, label: 'thingproxy'},
    {url: "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(url), label: 'codetabs'},
    {url: "https://corsproxy.io/?url=" + encodeURIComponent(url), label: 'corsproxy.io'},
    {url: "https://crossorigin.me/" + url, label: 'crossorigin.me'},
    {url: "https://proxy.corsfix.com/?" + encodeURIComponent(url), label: 'corsfix'}
  ];

  // Attempt to load via all proxies concurrently; resolve on first valid result.
  const proxyPromises = proxies.map(({url: purl, label}) => {
    return fetchText(purl).then(text => {
      if (looksLikeFeedXML(text)) {
        return { text, via: label };
      }
      // Force rejection if the response does not look like a feed
      return Promise.reject(new Error('Not a feed'));
    });
  });

  try {
    // Promise.any will resolve with the first fulfilled promise; if all reject it will throw.
    // Some older browsers do not support Promise.any; in that case the catch block below will handle the error.
    const result = await Promise.any(proxyPromises);
    if (result) return result;
  } catch (e) {
    // If Promise.any is unavailable or all proxies failed, fall back to sequential attempts.
    for (const {url: purl, label} of proxies) {
      try {
        const t = await fetchText(purl);
        if (looksLikeFeedXML(t)) return { text: t, via: label };
      } catch (e2) {}
    }
  }

  // Final fallback: allorigins /get returns JSON
  try {
    const res = await fetch(allOriginsGet, { cache: "no-store" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    const t = (data && data.contents) ? data.contents : "";
    if (looksLikeFeedXML(t)) return { text: t, via: 'allorigins(get)' };
  } catch (e) {}

  throw new Error("Unable to load feed (CORS/proxy)");
}

async function parseRSS(){
  const urlEl = $("rssUrl");
  const urlRaw = ((urlEl && typeof urlEl.value === "string") ? urlEl.value : (config.rssUrl || ""));
  const url = String(urlRaw||"").trim();

  const srcEl = $("feedSource");
  const xmlEl = $("feedXml");
  const feedSource = (srcEl ? (srcEl.value||"url") : (config.feedSource||"url"));
  const pasted = (xmlEl ? xmlEl.value : (config.feedXml||""));

  // If the URL field contains raw XML, treat it as pasted input (common user mistake).
  const urlLooksLikeXML = (!/^https?:\/\//i.test(url) && looksLikeFeedXML(url));

  if(feedSource === "paste" || urlLooksLikeXML){
    const xml = urlLooksLikeXML ? url : String(pasted||"");
    if(!xml || !looksLikeFeedXML(xml)){
      alert("Paste a valid RSS/Atom XML payload.");
      return;
    }
    config.feedSource = "paste";
    config.feedXml = urlLooksLikeXML ? url : String(pasted||"");
    if(urlLooksLikeXML && urlEl) urlEl.value = "";
  }else{
    if(!url){
      // If URL is empty but pasted XML exists, fall back automatically.
      if(pasted && looksLikeFeedXML(pasted)){
        config.feedSource = "paste";
        config.feedXml = pasted;
      }else{
        alert("Enter an RSS/Atom URL (or switch to Paste XML)." );
        return;
      }
    }
    config.feedSource = "url";
    config.rssUrl = url;
  }
  const modeEl = $("mappingMode");
  const mode = (modeEl ? modeEl.value : (config.mappingMode || "auto")) || "auto";
  config.mappingMode = mode;
  save();

  const btn=$("generateBtn"); if(btn) { btn.disabled=true; btn.textContent="Loading‚Ä¶"; }
  setStatus(config.feedSource === "paste" ? "Using pasted XML‚Ä¶" : "Fetching RSS‚Ä¶");
  try{
    let text = "";
    let via = "pasted";
    if(config.feedSource === "paste"){
      text = String(config.feedXml || "");
      via = "pasted";
    }else{
      const res = await fetchFeedText(config.rssUrl);
      text = res.text;
      via = res.via || "url";
    }
    setStatus("Parsing feed‚Ä¶" + (via ? (" ("+via+")") : ""));
    const xml=new DOMParser().parseFromString(text,"text/xml");
    if(xml.querySelector("parsererror")) throw new Error("Invalid RSS/Atom XML");
    let nodes=Array.from(xml.querySelectorAll("item")); if(!nodes.length) nodes=Array.from(xml.querySelectorAll("entry"));

    allArticles=nodes.map((item, idx)=>{
      const title=(item.querySelector("title")?.textContent||"").replace(/<!\[CDATA\[|\]\]>/g,"").trim()||"(no title)";
      let link=(item.querySelector("link")?.textContent||"").trim();
      if(!link){ const le=item.querySelector("link[href]"); if(le) link=le.getAttribute("href")||""; }

      const desc=item.querySelector("description")?.textContent || item.querySelector("summary")?.textContent || "";
      const content=item.querySelector("content\\:encoded")?.textContent || item.querySelector("content")?.textContent || "";
      const pc=pickPreviewAndComment(desc, content, mode);

      const pub = item.querySelector("pubDate, updated, published, dc\\:date")?.textContent || "";
      const pubDate=safeDate(pub);

      const tags = extractTagCandidates(item);

      let img=""; const html = item.querySelector("content\\:encoded")?.textContent || item.querySelector("description")?.textContent || "";
      const m = html.match(/<img[^>]+src=["']([^"']+)["']/i); if(m) img=m[1];

      return {
        id:idx,
        include:true,
        featured:false,
        title,
        link,
        preview: softenLongUrls(cleanText(pc.preview)),
        comment: softenLongUrls(cleanText(pc.comment)),
        tags,
        category:"Other",
        pubDate,
        image:img
      };
    });

        // Canonicalize tags (case-insensitive) so section labels stay stable across runs.
    canonicalTagByLower = new Map();
    try{
      const preferredRaw = []
        .concat(Array.isArray(config.sectionOrder)?config.sectionOrder:[])
        .concat(Object.keys(config.tagOverrides||{}));

      preferredRaw.forEach(t=>{
        const canon = normalizeTagName(t);
        if(!canon) return;
        canonicalTagByLower.set(canon.toLowerCase(), canon);
      });

      allArticles.forEach(a=>{
        (a.tags||[]).forEach(t=>{
          const canon = normalizeTagName(t);
          if(!canon) return;
          const k = canon.toLowerCase();
          if(!canonicalTagByLower.has(k)) canonicalTagByLower.set(k, canon);
        });
      });
    }catch(e){
      canonicalTagByLower = new Map();
    }

    // Apply canonical labels to each item's tags (ensures consistent grouping & color mapping)
    allArticles.forEach(a=>{
      const next = [];
      const seen = new Set();
      (a.tags||[]).forEach(t=>{
        const canon = normalizeTagName(t);
        if(!canon) return;
        const k = canon.toLowerCase();
        if(seen.has(k)) return;
        seen.add(k);
        next.push(canonicalTagByLower.get(k) || canon);
      });
      a.tags = next;
    });

    // Count tag frequencies across items (helps pick a good section when multiple tags exist).
    // We ignore workflow tags (see isNonSectionTag), but we do NOT auto-ignore topic tags.
    tagCounts = new Map();
    allArticles.forEach(a=>{
      const uniq = new Set();
      (a.tags||[]).forEach(t=>{
        const canon = normalizeTagName(t);
        if(!canon) return;
        const k = canon.toLowerCase();
        if(uniq.has(k)) return;
        uniq.add(k);
        if(isNonSectionTag(canon)) return;
        tagCounts.set(k, (tagCounts.get(k)||0) + 1);
      });
    });

// Assign category after auto-ignored tags are known
    allArticles.forEach(a=>{
      a.category = choosePrimarySection(a.tags);
    });

    const total = allArticles.length;
    const otherNoTags = allArticles.filter(a=>a.category==="Other" && (!a.tags || !a.tags.length)).length;
    const otherOnlyGeneric = allArticles.filter(a=>a.category==="Other" && (a.tags && a.tags.length)).length;

    // Diagnostics: helps spot feeds where tags are present but ignored/unknown
    const uniqAll = new Set();
    const uniqIgnored = new Set();
    allArticles.forEach(a=>{
      (a.tags||[]).forEach(t=>{
        const nt = normalizeTagName(t);
        if(!nt) return;
        (isNonSectionTag(nt) ? uniqIgnored : uniqAll).add(nt);
      });
    });
    if(uniqIgnored.size || uniqAll.size){
      console.info("Tag parsing summary:", {uniqueSectionTags:[...uniqAll], ignoredTags:[...uniqIgnored]});
    }

    let msg = `Loaded ${total} items`;
    const parts = [];
    if(otherNoTags) parts.push(`${otherNoTags} untagged`);
    if(otherOnlyGeneric) parts.push(`${otherOnlyGeneric} only generic tags`);
    if(parts.length) msg += ` (${parts.join(", ")} ‚Üí Other)`;
    if(uniqAll.size) msg += ` ¬∑ ${uniqAll.size} tags found`;
    setStatus(msg);
    save(); renderArticleList(); buildHTML();
  }catch(e){
    console.error(e);
    // Display a brief toast instead of a blocking alert when feed loading fails.
    toast("Feed load failed: " + (e?.message || e), "error");
    setStatus("Error: " + (e?.message || e) + " ‚Äî if this is a CORS issue try the Paste XML option");
  }
  finally{ if(btn){ btn.disabled=false; btn.textContent="Generate"; } }
}

function pickPreviewAndComment(desc, content, mode){
  const d=cleanText(desc), c=cleanText(content);
  if(mode==="descPreview_contentNote") return {preview:d, comment:c};
  if(mode==="contentPreview_descNote") return {preview:c||d, comment:d};
  if(mode==="descOnly") return {preview:d, comment:""};
  if(mode==="contentOnly") return {preview:c, comment:""};
  return {preview:c||d, comment: (c && d && c!==d)? d : ""};
}

// ============================ ENHANCED VISUAL EDITOR ============================
const VisualEditor = {
  isOpen: false,
  editingArticleId: null,
  draggedSection: null,
  draggedArticle: null,
  dragSourceSection: null,

  open() {
    if (!allArticles || allArticles.length === 0) {
      toast("Generate a template first", "warning");
      return;
    }
    this.isOpen = true;
    const panel = $("visualEditorPanel");
    if (panel) {
      panel.classList.add("active");
      document.body.style.overflow = "hidden";
    }
    this.renderSections();
    this.updatePreview();
  },

  close() {
    this.isOpen = false;
    const panel = $("visualEditorPanel");
    if (panel) {
      panel.classList.remove("active");
      document.body.style.overflow = "";
    }
  },

  applyChanges() {
    buildHTML();
    toast("Changes applied", "success");
  },

  renderSections() {
    const container = $("veSectionsList");
    if (!container) return;

    // Group articles by category
    const grouped = {};
    allArticles.forEach(a => {
      const cat = a.category || "Other";
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(a);
    });

    // Get ordered sections
    const order = computeOrder(grouped);

    if (order.length === 0) {
      container.innerHTML = `
        <div class="ve-empty">
          <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg>
          <p>No articles loaded. Generate a feed first.</p>
        </div>
      `;
      return;
    }

    let html = "";
    order.forEach((cat, secIdx) => {
      const items = grouped[cat] || [];
      const bg = colorFor(cat);
      const count = items.filter(a => a.include).length;
      const total = items.length;

      html += `
        <div class="ve-section" data-section="${esc(cat)}" draggable="true">
          <div class="ve-section-header">
            <span class="ve-section-drag" title="Drag to reorder section">‚ãÆ‚ãÆ</span>
            <span class="ve-section-color" style="background:${bg}"></span>
            <span class="ve-section-name">${esc(cat)}</span>
            <span class="ve-section-count">${count}/${total}</span>
            <button class="ve-section-toggle" data-section="${esc(cat)}" title="Toggle section">‚ñº</button>
          </div>
          <div class="ve-section-articles" data-section="${esc(cat)}">
            ${items.map(a => this.renderArticleItem(a, cat)).join("")}
          </div>
        </div>
      `;
    });

    container.innerHTML = html;
    this.bindSectionEvents(container);
  },

  renderArticleItem(article, section) {
    const domain = article.link ? new URL(article.link).hostname.replace("www.", "") : "";
    const featuredClass = article.featured ? "active" : "";
    const excludeClass = !article.include ? "exclude" : "";
    const title = article.title || "(no title)";
    const truncatedTitle = title.length > 80 ? title.substring(0, 80) + "..." : title;

    return `
      <div class="ve-article ${excludeClass}" data-id="${article.id}" data-section="${esc(section)}" draggable="true">
        <span class="ve-article-drag" title="Drag to reorder">‚ãÆ‚ãÆ</span>
        <div class="ve-article-content">
          <div class="ve-article-title">${esc(truncatedTitle)}</div>
          <div class="ve-article-meta">
            <span>${esc(domain)}</span>
            ${article.featured ? '<span style="color:#d97706">‚òÖ Featured</span>' : ''}
          </div>
        </div>
        <div class="ve-article-actions">
          <button class="ve-article-action ${featuredClass}" data-action="feature" data-id="${article.id}" title="Toggle featured">‚òÖ</button>
          <button class="ve-article-action" data-action="edit" data-id="${article.id}" title="Edit article">‚úé</button>
          <button class="ve-article-action ${article.include ? '' : 'active'}" data-action="toggle" data-id="${article.id}" title="Include/exclude">${article.include ? '‚úì' : '‚úï'}</button>
        </div>
      </div>
    `;
  },

  bindSectionEvents(container) {
    // Section toggle
    container.querySelectorAll(".ve-section-toggle").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const section = btn.getAttribute("data-section");
        const articles = container.querySelector(`.ve-section-articles[data-section="${section}"]`);
        if (articles) {
          articles.classList.toggle("collapsed");
          btn.classList.toggle("collapsed");
        }
      });
    });

    // Section drag & drop
    container.querySelectorAll(".ve-section").forEach(sec => {
      sec.addEventListener("dragstart", (e) => {
        if (e.target.classList.contains("ve-article")) return;
        this.draggedSection = sec.getAttribute("data-section");
        sec.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", "section:" + this.draggedSection);
      });

      sec.addEventListener("dragend", () => {
        sec.classList.remove("dragging");
        this.draggedSection = null;
        container.querySelectorAll(".ve-section").forEach(s => s.classList.remove("drag-over"));
      });

      sec.addEventListener("dragover", (e) => {
        if (!this.draggedSection) return;
        e.preventDefault();
        sec.classList.add("drag-over");
      });

      sec.addEventListener("dragleave", () => {
        sec.classList.remove("drag-over");
      });

      sec.addEventListener("drop", (e) => {
        e.preventDefault();
        sec.classList.remove("drag-over");
        if (!this.draggedSection) return;

        const targetSection = sec.getAttribute("data-section");
        if (this.draggedSection === targetSection) return;

        // Reorder sections
        const order = [...(config.sectionOrder || [])];
        if (!order.includes(this.draggedSection)) order.push(this.draggedSection);
        if (!order.includes(targetSection)) order.push(targetSection);

        const fromIdx = order.indexOf(this.draggedSection);
        const toIdx = order.indexOf(targetSection);
        order.splice(fromIdx, 1);
        order.splice(toIdx, 0, this.draggedSection);

        config.sectionOrder = order;
        save();
        this.renderSections();
        this.updatePreview();
        toast("Section reordered", "success");
      });
    });

    // Article drag & drop
    container.querySelectorAll(".ve-article").forEach(art => {
      art.addEventListener("dragstart", (e) => {
        e.stopPropagation();
        this.draggedArticle = parseInt(art.getAttribute("data-id"), 10);
        this.dragSourceSection = art.getAttribute("data-section");
        art.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", "article:" + this.draggedArticle);
      });

      art.addEventListener("dragend", () => {
        art.classList.remove("dragging");
        this.draggedArticle = null;
        this.dragSourceSection = null;
        container.querySelectorAll(".ve-article").forEach(a => a.classList.remove("drag-over"));
        container.querySelectorAll(".ve-section-articles").forEach(s => s.classList.remove("drag-over"));
      });

      art.addEventListener("dragover", (e) => {
        if (this.draggedArticle === null) return;
        e.preventDefault();
        e.stopPropagation();
        art.classList.add("drag-over");
      });

      art.addEventListener("dragleave", () => {
        art.classList.remove("drag-over");
      });

      art.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        art.classList.remove("drag-over");
        if (this.draggedArticle === null) return;

        const targetId = parseInt(art.getAttribute("data-id"), 10);
        const targetSection = art.getAttribute("data-section");
        if (this.draggedArticle === targetId) return;

        // Find articles
        const draggedArt = allArticles.find(a => a.id === this.draggedArticle);
        const targetArt = allArticles.find(a => a.id === targetId);
        if (!draggedArt || !targetArt) return;

        // If moving to different section, update category
        if (draggedArt.category !== targetSection) {
          draggedArt.category = targetSection;
        }

        // Reorder within section
        const sectionArticles = allArticles.filter(a => a.category === targetSection);
        const order = sectionArticles.map(a => a.id);
        const fromIdx = order.indexOf(this.draggedArticle);
        const toIdx = order.indexOf(targetId);

        if (fromIdx >= 0) {
          order.splice(fromIdx, 1);
        }
        order.splice(toIdx, 0, this.draggedArticle);

        order.forEach((id, idx) => {
          const a = allArticles.find(x => x.id === id);
          if (a) a.sortIndexCat = idx;
        });

        save();
        this.renderSections();
        this.updatePreview();
        toast("Article moved", "success");
      });
    });

    // Article section drop zones
    container.querySelectorAll(".ve-section-articles").forEach(zone => {
      zone.addEventListener("dragover", (e) => {
        if (this.draggedArticle === null) return;
        e.preventDefault();
        zone.classList.add("drag-over");
      });

      zone.addEventListener("dragleave", (e) => {
        if (!zone.contains(e.relatedTarget)) {
          zone.classList.remove("drag-over");
        }
      });

      zone.addEventListener("drop", (e) => {
        if (e.target.classList.contains("ve-article")) return; // Handled by article drop
        e.preventDefault();
        zone.classList.remove("drag-over");
        if (this.draggedArticle === null) return;

        const targetSection = zone.getAttribute("data-section");
        const draggedArt = allArticles.find(a => a.id === this.draggedArticle);
        if (!draggedArt) return;

        // Move to this section
        draggedArt.category = targetSection;
        draggedArt.sortIndexCat = 9999; // Add at end

        save();
        this.renderSections();
        this.updatePreview();
        toast("Article moved to " + targetSection, "success");
      });
    });

    // Article action buttons
    container.querySelectorAll(".ve-article-action").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const action = btn.getAttribute("data-action");
        const id = parseInt(btn.getAttribute("data-id"), 10);
        const article = allArticles.find(a => a.id === id);
        if (!article) return;

        if (action === "feature") {
          article.featured = !article.featured;
          save();
          this.renderSections();
          this.updatePreview();
        } else if (action === "toggle") {
          article.include = !article.include;
          save();
          this.renderSections();
          this.updatePreview();
        } else if (action === "edit") {
          this.openQuickEdit(id);
        }
      });
    });

    // Click on article to edit
    container.querySelectorAll(".ve-article-content").forEach(content => {
      content.addEventListener("click", () => {
        const art = content.closest(".ve-article");
        if (art) {
          const id = parseInt(art.getAttribute("data-id"), 10);
          this.openQuickEdit(id);
        }
      });
    });
  },

  openQuickEdit(id) {
    const article = allArticles.find(a => a.id === id);
    if (!article) return;

    this.editingArticleId = id;

    // Populate form
    $("veEditTitle").value = article.title || "";
    $("veEditPreview").value = article.preview || "";
    $("veEditComment").value = article.comment || "";
    $("veEditLink").value = article.link || "";
    $("veEditImage").value = article.image || "";
    $("veEditFeatured").checked = !!article.featured;

    // Show image preview if exists
    this.updateImagePreview(article.image);

    // Populate section dropdown
    const sectionSelect = $("veEditSection");
    sectionSelect.innerHTML = "";
    const sections = [...new Set(allArticles.map(a => a.category || "Other"))].sort();
    sections.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      if (s === article.category) opt.selected = true;
      sectionSelect.appendChild(opt);
    });

    // Show modal
    $("veQuickEditModal").classList.add("active");
  },

  updateImagePreview(url) {
    const preview = $("veImagePreview");
    const img = $("veImagePreviewImg");
    if (url && url.trim()) {
      img.src = url;
      preview.style.display = "flex";
      preview.style.alignItems = "center";
    } else {
      preview.style.display = "none";
      img.src = "";
    }
  },

  closeQuickEdit() {
    $("veQuickEditModal").classList.remove("active");
    this.editingArticleId = null;
    // Reset image preview
    $("veImagePreview").style.display = "none";
    $("veImagePreviewImg").src = "";
  },

  saveQuickEdit() {
    if (this.editingArticleId === null) return;

    const article = allArticles.find(a => a.id === this.editingArticleId);
    if (!article) return;

    article.title = $("veEditTitle").value;
    article.preview = $("veEditPreview").value;
    article.comment = $("veEditComment").value;
    article.link = $("veEditLink").value;
    article.image = $("veEditImage").value;
    article.featured = $("veEditFeatured").checked;

    const newSection = $("veEditSection").value;
    if (newSection !== article.category) {
      article.category = newSection;
      article.sortIndexCat = 9999;
    }

    save();
    this.closeQuickEdit();
    this.renderSections();
    this.updatePreview();
    toast("Article updated", "success");
  },

  updatePreview() {
    // Rebuild HTML and update preview
    const list = getFiltered();
    const sections = buildSections(list);
    htmlCode = outerHTML(sections);

    const frame = $("vePreviewFrameNew");
    if (frame) {
      frame.srcdoc = htmlCode;
    }

    // Also update main preview
    refreshPreview();
    populateSectionsBoard();
    renderArticleList();
  },

  initUI() {
    // Open button
    const openBtn = $("openVisualEditorBtn");
    if (openBtn) {
      openBtn.addEventListener("click", () => this.open());
    }

    // Close button
    const closeBtn = $("veCloseEditorBtn");
    if (closeBtn) {
      closeBtn.addEventListener("click", () => this.close());
    }

    // Apply button
    const applyBtn = $("veApplyChangesBtn");
    if (applyBtn) {
      applyBtn.addEventListener("click", () => {
        this.applyChanges();
        this.close();
      });
    }

    // Refresh button
    const refreshBtn = $("veRefreshPreviewBtn");
    if (refreshBtn) {
      refreshBtn.addEventListener("click", () => this.updatePreview());
    }

    // Zoom
    const zoomRange = $("veZoomRange");
    if (zoomRange) {
      zoomRange.addEventListener("input", () => {
        const frame = $("vePreviewFrameNew");
        if (frame) {
          frame.style.transform = `scale(${zoomRange.value})`;
          frame.style.transformOrigin = "top left";
          frame.style.width = `${100 / zoomRange.value}%`;
          frame.style.height = `${100 / zoomRange.value}%`;
        }
      });
    }

    // Quick edit modal
    const closeQuickEdit = $("veQuickEditClose");
    if (closeQuickEdit) {
      closeQuickEdit.addEventListener("click", () => this.closeQuickEdit());
    }

    const cancelQuickEdit = $("veQuickEditCancel");
    if (cancelQuickEdit) {
      cancelQuickEdit.addEventListener("click", () => this.closeQuickEdit());
    }

    const saveQuickEdit = $("veQuickEditSave");
    if (saveQuickEdit) {
      saveQuickEdit.addEventListener("click", () => this.saveQuickEdit());
    }

    // Close on escape
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if ($("veQuickEditModal").classList.contains("active")) {
          this.closeQuickEdit();
        } else if (this.isOpen) {
          this.close();
        }
      }
    });

    // Close modal on backdrop click
    $("veQuickEditModal").addEventListener("click", (e) => {
      if (e.target === $("veQuickEditModal")) {
        this.closeQuickEdit();
      }
    });

    // Live edit toggle
    const liveEditToggle = $("veLiveEditToggle");
    if (liveEditToggle) {
      liveEditToggle.addEventListener("change", () => {
        this.liveEditEnabled = liveEditToggle.checked;
        const hint = $("veLiveEditHint");
        if (hint) {
          hint.style.display = this.liveEditEnabled ? "block" : "none";
        }
        // Re-attach live editing if enabled
        if (this.liveEditEnabled) {
          const frame = $("vePreviewFrameNew");
          if (frame) this.attachLiveEditing(frame);
        } else {
          // Disable editing
          const frame = $("vePreviewFrameNew");
          if (frame && frame.contentDocument) {
            frame.contentDocument.querySelectorAll('[contenteditable="true"]').forEach(el => {
              el.removeAttribute("contenteditable");
            });
          }
        }
      });
    }

    // Image URL input - update preview on change
    const imageInput = $("veEditImage");
    if (imageInput) {
      imageInput.addEventListener("input", () => {
        this.updateImagePreview(imageInput.value);
      });
    }

    // Image file upload
    const imageUpload = $("veImageUpload");
    if (imageUpload) {
      imageUpload.addEventListener("change", (e) => {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        // Convert to base64 data URL
        const reader = new FileReader();
        reader.onload = (evt) => {
          const dataUrl = evt.target.result;
          $("veEditImage").value = dataUrl;
          this.updateImagePreview(dataUrl);
          toast("Image uploaded", "success");
        };
        reader.onerror = () => {
          toast("Failed to read image", "error");
        };
        reader.readAsDataURL(file);

        // Reset input for future uploads
        imageUpload.value = "";
      });
    }

    // Remove image button
    const removeImage = $("veImageRemove");
    if (removeImage) {
      removeImage.addEventListener("click", () => {
        $("veEditImage").value = "";
        this.updateImagePreview("");
      });
    }

    // Enable live editing in preview
    this.initLiveEditing();
  },

  initLiveEditing() {
    // Add click handler for live editing in preview
    const self = this;

    // Watch for preview frame loads to attach live editing
    const frame = $("vePreviewFrameNew");
    if (frame) {
      frame.addEventListener("load", () => {
        self.attachLiveEditing(frame);
      });
    }
  },

  liveEditEnabled: false,

  attachLiveEditing(frame) {
    if (!frame || !frame.contentDocument) return;
    if (!this.liveEditEnabled) return; // Only attach if live edit is enabled
    const doc = frame.contentDocument;

    // Inject live editing styles
    if (!doc.getElementById("liveEditStyles")) {
      const style = doc.createElement("style");
      style.id = "liveEditStyles";
      style.textContent = `
        [data-nl="article-title"],
        [data-nl="article-body"],
        [data-nl="section-title"] {
          cursor: text;
          outline: none;
          transition: box-shadow 0.15s ease;
        }
        [data-nl="article-title"]:hover,
        [data-nl="article-body"]:hover,
        [data-nl="section-title"]:hover {
          box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }
        [data-nl="article-title"]:focus,
        [data-nl="article-body"]:focus,
        [data-nl="section-title"]:focus {
          box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.6);
        }
        .live-edit-active {
          background: rgba(59, 130, 246, 0.05) !important;
        }
      `;
      doc.head.appendChild(style);
    }

    // Make text elements editable
    doc.querySelectorAll('[data-nl="article-title"], [data-nl="article-body"], [data-nl="section-title"]').forEach(el => {
      el.setAttribute("contenteditable", "true");
      el.setAttribute("spellcheck", "false");

      // Track changes
      el.addEventListener("focus", () => {
        el.classList.add("live-edit-active");
      });

      el.addEventListener("blur", () => {
        el.classList.remove("live-edit-active");
        // Sync changes back to htmlCode
        this.syncLiveEdits(frame);
      });

      el.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          el.blur();
        }
      });
    });

    // Disable link navigation
    doc.querySelectorAll("a").forEach(a => {
      a.addEventListener("click", (e) => {
        e.preventDefault();
      });
    });
  },

  syncLiveEdits(frame) {
    if (!frame || !frame.contentDocument) return;

    try {
      // Get the updated HTML from the iframe
      const doc = frame.contentDocument;
      const body = doc.body;
      if (!body) return;

      // Update the main htmlCode
      htmlCode = "<!DOCTYPE html><html>" + doc.documentElement.innerHTML + "</html>";

      // Also update the main preview
      refreshPreview();
      toast("Changes synced", "success");
    } catch (e) {
      console.warn("Failed to sync live edits:", e);
    }
  }
};

// ============================ INIT ============================
function onReady(){
  load();
  initUIMode(); bindDock();
  bindHeader(); bindToc(); bindLayout();
  bindFeedControls();
  bindFilters();

  const zr = $("zoomRange");
  if(zr) zr.addEventListener("input", ()=>{ config.zoom=parseFloat($("zoomRange").value)||1; applyZoom(config.zoom); save(); });
  document.addEventListener("click", (e)=>{
    const zb=e.target.closest("[data-zoom]"); if(!zb) return;
    const v=parseFloat(zb.getAttribute("data-zoom")); $("zoomRange").value=v; config.zoom=v; applyZoom(v); save();
  });
  InlineEditor.initUI();
  VisualEditor.initUI();
  if($("visualEditBtn")) $("visualEditBtn").addEventListener("click", ()=>InlineEditor.toggle());
  if($("applyVisualBtn")) $("applyVisualBtn").addEventListener("click", applyInlineEdits);

  document.addEventListener("keydown", (e)=>{
    if(e.key==="Escape"){
      const vm = $("visualModal");
      if(vm && vm.style.display==="flex") closeVisualEditor();
    }
  });

  if($("outlookPreviewToggle")) $("outlookPreviewToggle").addEventListener("change",()=>{ refreshPreview(); });

  if($("copyBtn")) $("copyBtn").onclick=async ()=>{
    try{
      let txt=$("minifyToggle")?.checked?minify(htmlCode):htmlCode;
      if($("outlookSafeToggle")?.checked) txt = outlookSafeTransform(txt);
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(txt);
        toast("Copied to clipboard", "success");
      }else{
        const w = window.open(); w.document.write("<pre>"+esc(txt)+"</pre>");
      }
    }catch(e){
      // Use toast notification instead of intrusive alert for copy failure
      console.warn(e);
      toast("Copy failed", "error");
    }
  };
  if($("downloadBtn")) $("downloadBtn").onclick=()=>{
    let txt=$("minifyToggle")?.checked?minify(htmlCode):htmlCode;
    if($("outlookSafeToggle")?.checked) txt = outlookSafeTransform(txt);
    const blob = new Blob([txt], {type:"text/html"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "newsletter.html"; document.body.appendChild(a); a.click(); a.remove();
  };

  // Settings export/import/reset (Advanced)
  const filterConfig = (src)=>{
    const out = {};
    Object.keys(DEFAULT_CONFIG).forEach(k=>{
      if(Object.prototype.hasOwnProperty.call(src||{}, k)) out[k] = src[k];
    });
    out.feedXml = "";
    if(out.feedSource === "paste") out.feedSource = "url";
    return out;
  };

  if($("exportSettingsBtn")) $("exportSettingsBtn").onclick=()=>{
    try{
      const payload = {
        format: "rss-newsletter-generator-settings",
        version: 1,
        exportedAt: new Date().toISOString(),
        config: filterConfig(config)
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "newsletter_settings.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      toast("Settings exported", "success");
    }catch(e){
      console.warn(e);
      // Show failure via toast instead of blocking alert
      toast("Export failed", "error");
    }
  };

  const importEl = $("importSettingsFile");
  if(importEl) importEl.addEventListener("change", async ()=>{
    const f = importEl.files && importEl.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt||"{}");
      const src = (obj && obj.config) ? obj.config : obj;
      const next = filterConfig(src||{});
      Object.assign(config, next);
      normalizeConfig();
      save();
      toast("Settings imported ‚Äî reloading", "success");
      setTimeout(()=>location.reload(), 250);
    }catch(e){
      console.warn(e);
      // Use toast notification for JSON parsing errors
      toast("Import failed: invalid JSON", "error");
    }finally{
      importEl.value = "";
    }
  });

  if($("resetToolBtn")) $("resetToolBtn").onclick=()=>{
    if(!confirm("Reset all settings and clear loaded items?")) return;
    try{ localStorage.removeItem("tg42"); }catch(e){}
    location.reload();
  };

  ["minifyToggle","outlookSafeToggle"].forEach(id=>{
    const el = $(id);
    if(el) el.addEventListener("change", updateLint);
  });

  if($("generateBtn")) $("generateBtn").addEventListener("click", parseRSS);
  if($("refreshBtn")) $("refreshBtn").addEventListener("click", ()=>buildHTML());

  if($("zoomRange")) $("zoomRange").value = config.zoom||1;

  populateSectionsBoard();
}
document.addEventListener("DOMContentLoaded", onReady);
</script>
</body>
</html>